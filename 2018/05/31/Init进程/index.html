<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="一.概述Init进程是Linux系统中用户空间的第一个进程，Android是基于Linux内核的，所以init也是Android系统中用户空间的第一个进程，进程号是1。在Init初始化的过程中会启动很多重要的守护进程，当然Init本身也是一个守护进程。 二.Init进程的初始化过程Init进程的源码位于\system\core\init\下。程序的入口函数main()位于init.cpp中。 2.">
<meta property="og:type" content="article">
<meta property="og:title" content="Init进程">
<meta property="og:url" content="http://yoursite.com/2018/05/31/Init进程/index.html">
<meta property="og:site_name" content="道墟">
<meta property="og:description" content="一.概述Init进程是Linux系统中用户空间的第一个进程，Android是基于Linux内核的，所以init也是Android系统中用户空间的第一个进程，进程号是1。在Init初始化的过程中会启动很多重要的守护进程，当然Init本身也是一个守护进程。 二.Init进程的初始化过程Init进程的源码位于\system\core\init\下。程序的入口函数main()位于init.cpp中。 2.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-06-12T02:30:30.466Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Init进程">
<meta name="twitter:description" content="一.概述Init进程是Linux系统中用户空间的第一个进程，Android是基于Linux内核的，所以init也是Android系统中用户空间的第一个进程，进程号是1。在Init初始化的过程中会启动很多重要的守护进程，当然Init本身也是一个守护进程。 二.Init进程的初始化过程Init进程的源码位于\system\core\init\下。程序的入口函数main()位于init.cpp中。 2.">






  <link rel="canonical" href="http://yoursite.com/2018/05/31/Init进程/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Init进程 | 道墟</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">道墟</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">初九，潜龙勿用</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Startseite</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archiv</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/31/Init进程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="道墟">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="道墟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Init进程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-05-31 14:32:00" itemprop="dateCreated datePublished" datetime="2018-05-31T14:32:00+08:00">2018-05-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Updated at: 2018-06-12 10:30:30" itemprop="dateModified" datetime="2018-06-12T10:30:30+08:00">2018-06-12</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/android6-0/" itemprop="url" rel="index"><span itemprop="name">android6.0</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="一-概述"><a href="#一-概述" class="headerlink" title="一.概述"></a>一.概述</h1><p>Init进程是Linux系统中用户空间的第一个进程，Android是基于Linux内核的，所以init也是Android系统中用户空间的第一个进程，进程号是1。在Init初始化的过程中会启动很多重要的守护进程，当然Init本身也是<strong>一个守护进程</strong>。</p>
<h1 id="二-Init进程的初始化过程"><a href="#二-Init进程的初始化过程" class="headerlink" title="二.Init进程的初始化过程"></a>二.Init进程的初始化过程</h1><p>Init进程的源码位于\system\core\init\下。程序的入口函数main()位于init.cpp中。</p>
<h1 id="2-1-main函数的流程"><a href="#2-1-main函数的流程" class="headerlink" title="2.1 main函数的流程"></a>2.1 main函数的流程</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//2.1.1 选择启动程序</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"ueventd"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ueventd_main(argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"watchdogd"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> watchdogd_main(argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//2.1.2 设置进程创建的文件的属性</span></span><br><span class="line">    <span class="comment">// Clear the umask.</span></span><br><span class="line">    umask(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    add_environment(<span class="string">"PATH"</span>, _PATH_DEFPATH);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.1.3 创建目录和挂载文件系统</span></span><br><span class="line">    <span class="keyword">bool</span> is_first_stage = (argc == <span class="number">1</span>) || (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--second-stage"</span>) != <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class="line">    <span class="comment">// on / and then we'll let the rc file figure out the rest.</span></span><br><span class="line">    <span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">        mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>);</span><br><span class="line">        mkdir(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>);</span><br><span class="line">        mkdir(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>);</span><br><span class="line">        mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.1.4 初始化log系统</span></span><br><span class="line">    <span class="comment">// We must have some place other than / to create the device nodes for</span></span><br><span class="line">    <span class="comment">// kmsg and null, otherwise we won't be able to remount / read-only</span></span><br><span class="line">    <span class="comment">// later on. Now that tmpfs is mounted on /dev, we can actually talk</span></span><br><span class="line">    <span class="comment">// to the outside world.</span></span><br><span class="line">    open_devnull_stdio();</span><br><span class="line">    klog_init();</span><br><span class="line">    klog_set_level(KLOG_NOTICE_LEVEL);</span><br><span class="line"></span><br><span class="line">    NOTICE(<span class="string">"init%s started!\n"</span>, is_first_stage ? <span class="string">""</span> : <span class="string">" second stage"</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//2.1.5 初始化属性系统</span></span><br><span class="line">    <span class="keyword">if</span> (!is_first_stage) &#123;</span><br><span class="line">        <span class="comment">// Indicate that booting is in progress to background fw loaders, etc.</span></span><br><span class="line">        close(open(<span class="string">"/dev/.booting"</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="number">0000</span>));</span><br><span class="line"></span><br><span class="line">        property_init();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If arguments are passed both on the command line and in DT,</span></span><br><span class="line">        <span class="comment">// properties set in DT always have priority over the command-line ones.</span></span><br><span class="line">        process_kernel_dt();</span><br><span class="line">        process_kernel_cmdline();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Propogate the kernel variables to internal variables</span></span><br><span class="line">        <span class="comment">// used by init as well as the current required properties.</span></span><br><span class="line">        export_kernel_boot_props();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.1.6 初始化SELinux内核</span></span><br><span class="line">    <span class="comment">// Set up SELinux, including loading the SELinux policy if we're in the kernel domain.</span></span><br><span class="line">    selinux_initialize(is_first_stage);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're in the kernel domain, re-exec init to transition to the init domain now</span></span><br><span class="line">    <span class="comment">// that the SELinux policy has been loaded.</span></span><br><span class="line">    <span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">        <span class="keyword">if</span> (restorecon(<span class="string">"/init"</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"restorecon failed: %s\n"</span>, strerror(errno));</span><br><span class="line">            security_failure();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span>* path = argv[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">char</span>* args[] = &#123; path, <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">"--second-stage"</span>), <span class="literal">nullptr</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> (execv(path, args) == <span class="number">-1</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"execv(\"%s\") failed: %s\n"</span>, path, strerror(errno));</span><br><span class="line">            security_failure();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These directories were necessarily created before initial policy load</span></span><br><span class="line">    <span class="comment">// and therefore need their security context restored to the proper value.</span></span><br><span class="line">    <span class="comment">// This must happen before /dev is populated by ueventd.</span></span><br><span class="line">    INFO(<span class="string">"Running restorecon...\n"</span>);</span><br><span class="line">    restorecon(<span class="string">"/dev"</span>);</span><br><span class="line">    restorecon(<span class="string">"/dev/socket"</span>);</span><br><span class="line">    restorecon(<span class="string">"/dev/__properties__"</span>);</span><br><span class="line">    restorecon_recursive(<span class="string">"/sys"</span>);</span><br><span class="line"></span><br><span class="line">    epoll_fd = epoll_create1(EPOLL_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (epoll_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"epoll_create1 failed: %s\n"</span>, strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1.7 初始化子进程退出的信号处理过程</span></span><br><span class="line">    signal_handler_init();</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//2.1.8 设置系统属性的默认值</span></span><br><span class="line">    property_load_boot_defaults();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//2.1.9 启动属性服务（sockect）</span></span><br><span class="line">    start_property_service();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.1.10 解析init.rc文件</span></span><br><span class="line">    init_parse_config_file(<span class="string">"/init.rc"</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//2.1.11 初始化执行列表action_queue</span></span><br><span class="line">    action_for_each_trigger(<span class="string">"early-init"</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class="line">    queue_builtin_action(wait_for_coldboot_done_action, <span class="string">"wait_for_coldboot_done"</span>);</span><br><span class="line">    <span class="comment">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class="line">    queue_builtin_action(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</span><br><span class="line">    queue_builtin_action(keychord_init_action, <span class="string">"keychord_init"</span>);</span><br><span class="line">    queue_builtin_action(console_init_action, <span class="string">"console_init"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger all the boot actions to get us started.</span></span><br><span class="line">    action_for_each_trigger(<span class="string">"init"</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class="line">    <span class="comment">// wasn't ready immediately after wait_for_coldboot_done</span></span><br><span class="line">    queue_builtin_action(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don't mount filesystems or start core system services in charger mode.</span></span><br><span class="line">    <span class="keyword">char</span> bootmode[PROP_VALUE_MAX];</span><br><span class="line">    <span class="keyword">if</span> (property_get(<span class="string">"ro.bootmode"</span>, bootmode) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(bootmode, <span class="string">"charger"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        action_for_each_trigger(<span class="string">"charger"</span>, action_add_queue_tail);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        action_for_each_trigger(<span class="string">"late-init"</span>, action_add_queue_tail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run all property triggers based on current state of the properties.</span></span><br><span class="line">    queue_builtin_action(queue_property_triggers_action, <span class="string">"queue_property_triggers"</span>);</span><br><span class="line">    <span class="comment">//2.1.12 无限循环执行</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!waiting_for_exec) &#123;</span><br><span class="line">            execute_one_command();</span><br><span class="line">            restart_processes();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> timeout = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (process_needs_restart) &#123;</span><br><span class="line">            timeout = (process_needs_restart - gettime()) * <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">                timeout = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!action_queue_empty() || cur_action) &#123;</span><br><span class="line">            timeout = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bootchart_sample(&amp;timeout);</span><br><span class="line"></span><br><span class="line">        epoll_event ev;</span><br><span class="line">        <span class="keyword">int</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;ev, <span class="number">1</span>, timeout));</span><br><span class="line">        <span class="keyword">if</span> (nr == <span class="number">-1</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"epoll_wait failed: %s\n"</span>, strerror(errno));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr == <span class="number">1</span>) &#123;</span><br><span class="line">            ((<span class="keyword">void</span> (*)()) ev.data.ptr)();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-1-1-选择启动程序"><a href="#2-1-1-选择启动程序" class="headerlink" title="2.1.1 选择启动程序"></a>2.1.1 选择启动程序</h1><p>因为Init和ueventd和watchdogd守护进程的代码存在大量的代码重合，所以直接合并到一个文件中，通过参数来判断执行那个守护进程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"ueventd"</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> ueventd_main(argc, argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"watchdogd"</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> watchdogd_main(argc, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-1-2-设置进程创建的文件的属性"><a href="#2-1-2-设置进程创建的文件的属性" class="headerlink" title="2.1.2 设置进程创建的文件的属性"></a>2.1.2 设置进程创建的文件的属性</h1><p><strong>缺省情况下一个进程创建的文件属性是022</strong>，使用umask可以设置文件属性的掩码。参数为0表示掩码为0777。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Clear the umask.</span></span><br><span class="line">umask(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<h1 id="2-1-3-创建目录和挂载文件系统"><a href="#2-1-3-创建目录和挂载文件系统" class="headerlink" title="2.1.3 创建目录和挂载文件系统"></a>2.1.3 创建目录和挂载文件系统</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//确保只执行一次</span></span><br><span class="line"><span class="keyword">bool</span> is_first_stage = (argc == <span class="number">1</span>) || (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--second-stage"</span>) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class="line"><span class="comment">// on / and then we'll let the rc file figure out the rest.</span></span><br><span class="line"><span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">    mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>);</span><br><span class="line">    mkdir(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>);</span><br><span class="line">    mkdir(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>);</span><br><span class="line">    mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tmpfs是一种基于内存的文件系统，mount后就可以使用。tmpfs文件系统下的所有文件都存放在内存中，访问速度快，但是关机后会消失，适合用来存放临时性的文件。而且tmpfs文件系统的大小是动态变化的，一开始很小，随着文件的增多会随之变大。从上面的代码我们可以看到Android系统将tmpfs文件系统挂载到/dev目录下，而这个目录是用来保存系统创造的设备节点，正好符合tmpfs的特点。</p>
<p>devpts是虚拟终端文件系统，通常mount在目录/dev/pts下。</p>
<h1 id="2-1-4-初始化log系统"><a href="#2-1-4-初始化log系统" class="headerlink" title="2.1.4 初始化log系统"></a>2.1.4 初始化log系统</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将标准输入、输出、错误重定向到空设备文件/dev/null下，这是守护进程常用的手段</span></span><br><span class="line">   open_devnull_stdio();</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建设备节点/dev/kmsg,这样init进程就可以使用kernel的log系统，之所以是用使用kernel的log系统是因为这时候android层的log系统还没有启动起来</span></span><br><span class="line">   klog_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置log级别</span></span><br><span class="line">   klog_set_level(KLOG_NOTICE_LEVEL);</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印init进程开始启动的日志</span></span><br><span class="line">   NOTICE(<span class="string">"init%s started!\n"</span>, is_first_stage ? <span class="string">""</span> : <span class="string">" second stage"</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>日志输出级别的宏定义如下<br> KLOG_ERROR_LEVEL 3<br> KLOG_WARNING_LEVEL 4<br> KLOG_NOTICE_LEVEL 5<br> KLOG_INFO_LEVEL 6<br> KLOG_DEBUG_LEVEL 7<br> KLOG_DEFAULT_LEVEL 3 //默认为3<br>当我们设置的级别低于5的时候会输出到 kernel log 中</p>
</blockquote>
<h1 id="2-1-5-初始化属性系统"><a href="#2-1-5-初始化属性系统" class="headerlink" title="2.1.5 初始化属性系统"></a>2.1.5 初始化属性系统</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!is_first_stage) &#123;</span><br><span class="line"><span class="comment">//在/dev下创建一个设备表示正在初始化中，当初始化完成则移除</span></span><br><span class="line"><span class="comment">// Indicate that booting is in progress to background fw loaders, etc.</span></span><br><span class="line">      close(open(<span class="string">"/dev/.booting"</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="number">0000</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个共享区域来存储属性值</span></span><br><span class="line">      property_init();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If arguments are passed both on the command line and in DT,</span></span><br><span class="line">      <span class="comment">// properties set in DT always have priority over the command-line ones.</span></span><br><span class="line">      process_kernel_dt();</span><br><span class="line"><span class="comment">//解析kernel的启动参数</span></span><br><span class="line">      process_kernel_cmdline();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Propogate the kernel variables to internal variables</span></span><br><span class="line">      <span class="comment">// used by init as well as the current required properties.</span></span><br><span class="line">      export_kernel_boot_props();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-1-6-初始化SELinux内核"><a href="#2-1-6-初始化SELinux内核" class="headerlink" title="2.1.6 初始化SELinux内核"></a>2.1.6 初始化SELinux内核</h1><p>SELinux内核是android4.3开始引入的。在后面的解析系列中会重点解析这块。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set up SELinux, including loading the SELinux policy if we're in the kernel domain.</span></span><br><span class="line">selinux_initialize(is_first_stage);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we're in the kernel domain, re-exec init to transition to the init domain now</span></span><br><span class="line"><span class="comment">// that the SELinux policy has been loaded.</span></span><br><span class="line"><span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">    <span class="keyword">if</span> (restorecon(<span class="string">"/init"</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"restorecon failed: %s\n"</span>, strerror(errno));</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span>* path = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">char</span>* args[] = &#123; path, <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">"--second-stage"</span>), <span class="literal">nullptr</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (execv(path, args) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"execv(\"%s\") failed: %s\n"</span>, path, strerror(errno));</span><br><span class="line">        security_failure();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These directories were necessarily created before initial policy load</span></span><br><span class="line"><span class="comment">// and therefore need their security context restored to the proper value.</span></span><br><span class="line"><span class="comment">// This must happen before /dev is populated by ueventd.</span></span><br><span class="line">INFO(<span class="string">"Running restorecon...\n"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev/socket"</span>);</span><br><span class="line">restorecon(<span class="string">"/dev/__properties__"</span>);</span><br><span class="line">restorecon_recursive(<span class="string">"/sys"</span>);</span><br><span class="line"></span><br><span class="line">epoll_fd = epoll_create1(EPOLL_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (epoll_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    ERROR(<span class="string">"epoll_create1 failed: %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-1-7-初始化子进程退出的信号处理过程"><a href="#2-1-7-初始化子进程退出的信号处理过程" class="headerlink" title="2.1.7 初始化子进程退出的信号处理过程"></a>2.1.7 初始化子进程退出的信号处理过程</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal_handler_init();</span><br></pre></td></tr></table></figure>
<h1 id="2-1-8-设置系统属性的默认值"><a href="#2-1-8-设置系统属性的默认值" class="headerlink" title="2.1.8 设置系统属性的默认值"></a>2.1.8 设置系统属性的默认值</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">property_load_boot_defaults();</span><br></pre></td></tr></table></figure>
<p>上面的函数会从设备的根目录下的default.prop文件(路径:/default.prop)的属性值读取设置到属性系统中。</p>
<p>下面是截取的nexu5x 6.0系统模拟器下的文件值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># ADDITIONAL_DEFAULT_PROPERTIES</span><br><span class="line">#</span><br><span class="line">ro.secure=1</span><br><span class="line">ro.allow.mock.location=0</span><br><span class="line">ro.debuggable=1</span><br><span class="line">ro.zygote=zygote32</span><br><span class="line">dalvik.vm.image-dex2oat-Xms=64m</span><br><span class="line">dalvik.vm.image-dex2oat-Xmx=64m</span><br><span class="line">dalvik.vm.dex2oat-Xms=64m</span><br><span class="line">dalvik.vm.dex2oat-Xmx=512m</span><br><span class="line">ro.dalvik.vm.native.bridge=0</span><br><span class="line">debug.atrace.tags.enableflags=0</span><br><span class="line">#</span><br><span class="line"># BOOTIMAGE_BUILD_PROPERTIES</span><br><span class="line">#</span><br><span class="line">ro.bootimage.build.date=Wed Dec 13 00:51:01 UTC 2017</span><br><span class="line">ro.bootimage.build.date.utc=1513126261</span><br><span class="line">ro.bootimage.build.fingerprint=Android/sdk_google_phone_x86/generic_x86:6.0/MASTER/4499259:userdebug/test-keys</span><br><span class="line">persist.sys.usb.config=adb</span><br></pre></td></tr></table></figure></p>
<h1 id="2-1-9-启动属性服务（sockect）"><a href="#2-1-9-启动属性服务（sockect）" class="headerlink" title="2.1.9 启动属性服务（sockect）"></a>2.1.9 启动属性服务（sockect）</h1><p>读取相应文件的属性，下文5.3中有介绍。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start_property_service();</span><br></pre></td></tr></table></figure></p>
<h1 id="2-1-10-解析init-rc文件"><a href="#2-1-10-解析init-rc文件" class="headerlink" title="2.1.10 解析init.rc文件"></a>2.1.10 解析init.rc文件</h1><p>解析完成后的结果是将init文件中的Server项和Action项分别加入到内部Service列表:service_list 和Action列表:action_list<br>解析的过程会在下面的详细的分析</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init_parse_config_file(<span class="string">"/init.rc"</span>);</span><br></pre></td></tr></table></figure>
<h1 id="2-1-11-初始化执行列表action-queue"><a href="#2-1-11-初始化执行列表action-queue" class="headerlink" title="2.1.11 初始化执行列表action_queue"></a>2.1.11 初始化执行列表action_queue</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//将rc文件中触发器为early-init的action添加到执行列表</span></span><br><span class="line">action_for_each_trigger(<span class="string">"early-init"</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line"><span class="comment">//queue_builtin_action 作用就是将一个函数和一个名称生成action并插入到执行列表</span></span><br><span class="line">   <span class="comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class="line"><span class="comment">//等待冷插拔设备初始化完成</span></span><br><span class="line">   queue_builtin_action(wait_for_coldboot_done_action, <span class="string">"wait_for_coldboot_done"</span>);</span><br><span class="line">   <span class="comment">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class="line">   <span class="comment">//从硬件RNG的设备文件/dev/hw_randow中读取512字节并写到Linux RNGd的设备文件/dev/urandom中（这块因为水平有限，还未知道具体作用）</span></span><br><span class="line">queue_builtin_action(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</span><br><span class="line"><span class="comment">//初始化组合键监听模块</span></span><br><span class="line">   queue_builtin_action(keychord_init_action, <span class="string">"keychord_init"</span>);</span><br><span class="line"><span class="comment">//在屏幕上显示Android字样的Logo</span></span><br><span class="line">   queue_builtin_action(console_init_action, <span class="string">"console_init"</span>);</span><br><span class="line">	</span><br><span class="line"><span class="comment">//将rc文件中触发器为init的action添加到执行列表</span></span><br><span class="line">   <span class="comment">// Trigger all the boot actions to get us started.</span></span><br><span class="line">   action_for_each_trigger(<span class="string">"init"</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class="line">   <span class="comment">// wasn't ready immediately after wait_for_coldboot_done</span></span><br><span class="line">   queue_builtin_action(mix_hwrng_into_linux_rng_action, <span class="string">"mix_hwrng_into_linux_rng"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//当处于充电模式，则charger加入执行队列；否则late-init加入队列。</span></span><br><span class="line">   <span class="comment">// Don't mount filesystems or start core system services in charger mode.</span></span><br><span class="line">   <span class="keyword">char</span> bootmode[PROP_VALUE_MAX];</span><br><span class="line">   <span class="keyword">if</span> (property_get(<span class="string">"ro.bootmode"</span>, bootmode) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(bootmode, <span class="string">"charger"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">       action_for_each_trigger(<span class="string">"charger"</span>, action_add_queue_tail);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       action_for_each_trigger(<span class="string">"late-init"</span>, action_add_queue_tail);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查Action列表中通过修改属性来触发的Action，查看相关的属性是否已经设置了，如果已经设置则将该action加入到执行列表</span></span><br><span class="line">   <span class="comment">// Run all property triggers based on current state of the properties.</span></span><br><span class="line">   queue_builtin_action(queue_property_triggers_action, <span class="string">"queue_property_triggers"</span>);</span><br></pre></td></tr></table></figure>
<h1 id="2-1-12-无限循环执行"><a href="#2-1-12-无限循环执行" class="headerlink" title="2.1.12 无限循环执行"></a>2.1.12 无限循环执行</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (!waiting_for_exec) &#123;</span><br><span class="line">         execute_one_command();</span><br><span class="line">         restart_processes();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">int</span> timeout = <span class="number">-1</span>;</span><br><span class="line">     <span class="keyword">if</span> (process_needs_restart) &#123;</span><br><span class="line">         timeout = (process_needs_restart - gettime()) * <span class="number">1000</span>;</span><br><span class="line">         <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">             timeout = <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!action_queue_empty() || cur_action) &#123;</span><br><span class="line">         timeout = <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     bootchart_sample(&amp;timeout);</span><br><span class="line"></span><br><span class="line">     epoll_event ev;</span><br><span class="line">     <span class="keyword">int</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;ev, <span class="number">1</span>, timeout));</span><br><span class="line">     <span class="keyword">if</span> (nr == <span class="number">-1</span>) &#123;</span><br><span class="line">         ERROR(<span class="string">"epoll_wait failed: %s\n"</span>, strerror(errno));</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr == <span class="number">1</span>) &#123;</span><br><span class="line">         ((<span class="keyword">void</span> (*)()) ev.data.ptr)();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-2-启动Service进程"><a href="#2-2-启动Service进程" class="headerlink" title="2.2 启动Service进程"></a>2.2 启动Service进程</h1><p>上面最后无限循环的过程中 restart_processes 函数会检查service_list中所有服务，对于带有SVC_RESTARTING标志的服务，将服务作为参数调用 restart_service_if_needed</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restart_service_if_needed</span><span class="params">(struct service *svc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">time_t</span> next_start_time = svc-&gt;time_started + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next_start_time &lt;= gettime()) &#123;</span><br><span class="line">        svc-&gt;flags &amp;= (~SVC_RESTARTING);</span><br><span class="line">        service_start(svc, <span class="literal">NULL</span>); </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((next_start_time &lt; process_needs_restart) ||</span><br><span class="line">        (process_needs_restart == <span class="number">0</span>)) &#123;</span><br><span class="line">        process_needs_restart = next_start_time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面代码可以看出最后调用了service_start方法，下面我们来分析这个方法。</p>
<h1 id="2-2-1-重置Service结构中的标志和可执行判断"><a href="#2-2-1-重置Service结构中的标志和可执行判断" class="headerlink" title="2.2.1 重置Service结构中的标志和可执行判断"></a>2.2.1 重置Service结构中的标志和可执行判断</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// Starting a service removes it from the disabled or reset state and</span></span><br><span class="line">   <span class="comment">// immediately takes it out of the restarting state if it was in there.</span></span><br><span class="line"><span class="comment">//这四个都是跟启动相关的所以直接去掉</span></span><br><span class="line">   svc-&gt;flags &amp;= (~(SVC_DISABLED|SVC_RESTARTING|SVC_RESET|SVC_RESTART|SVC_DISABLED_START));</span><br><span class="line">   svc-&gt;time_started = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果已经在启动了则不需要再执行</span></span><br><span class="line">   <span class="comment">// Running processes require no additional work --- if they're in the</span></span><br><span class="line">   <span class="comment">// process of exiting, we've ensured that they will immediately restart</span></span><br><span class="line">   <span class="comment">// on exit, unless they are ONESHOT.</span></span><br><span class="line">   <span class="keyword">if</span> (svc-&gt;flags &amp; SVC_RUNNING) &#123;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果服务需要控制台，但是控制台没有启动则退出</span></span><br><span class="line">   <span class="keyword">bool</span> needs_console = (svc-&gt;flags &amp; SVC_CONSOLE);</span><br><span class="line">   <span class="keyword">if</span> (needs_console &amp;&amp; !have_console) &#123;</span><br><span class="line">       ERROR(<span class="string">"service '%s' requires console\n"</span>, svc-&gt;name);</span><br><span class="line">       svc-&gt;flags |= SVC_DISABLED;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查服务的二进制文件是否存在</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">s</span>;</span></span><br><span class="line">   <span class="keyword">if</span> (stat(svc-&gt;args[<span class="number">0</span>], &amp;s) != <span class="number">0</span>) &#123;</span><br><span class="line">       ERROR(<span class="string">"cannot find '%s', disabling '%s'\n"</span>, svc-&gt;args[<span class="number">0</span>], svc-&gt;name);</span><br><span class="line">       svc-&gt;flags |= SVC_DISABLED;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查服务是否有SVC_ONESHOT参数</span></span><br><span class="line">   <span class="keyword">if</span> ((!(svc-&gt;flags &amp; SVC_ONESHOT)) &amp;&amp; dynamic_args) &#123;</span><br><span class="line">       ERROR(<span class="string">"service '%s' must be one-shot to use dynamic args, disabling\n"</span>,</span><br><span class="line">              svc-&gt;args[<span class="number">0</span>]);</span><br><span class="line">       svc-&gt;flags |= SVC_DISABLED;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-2-2-设置安全上下文"><a href="#2-2-2-设置安全上下文" class="headerlink" title="2.2.2 设置安全上下文"></a>2.2.2 设置安全上下文</h1><p>关于安全机制在后续的文章中分析</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>* scon = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (is_selinux_enabled() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (svc-&gt;seclabel) &#123;</span><br><span class="line">        scon = strdup(svc-&gt;seclabel);</span><br><span class="line">        <span class="keyword">if</span> (!scon) &#123;</span><br><span class="line">            ERROR(<span class="string">"Out of memory while starting '%s'\n"</span>, svc-&gt;name);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">char</span> *mycon = <span class="literal">NULL</span>, *fcon = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        INFO(<span class="string">"computing context for service '%s'\n"</span>, svc-&gt;args[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">int</span> rc = getcon(&amp;mycon);</span><br><span class="line">        <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"could not get context while starting '%s'\n"</span>, svc-&gt;name);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rc = getfilecon(svc-&gt;args[<span class="number">0</span>], &amp;fcon);</span><br><span class="line">        <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"could not get context while starting '%s'\n"</span>, svc-&gt;name);</span><br><span class="line">            freecon(mycon);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rc = security_compute_create(mycon, fcon, string_to_security_class(<span class="string">"process"</span>), &amp;scon);</span><br><span class="line">        <span class="keyword">if</span> (rc == <span class="number">0</span> &amp;&amp; !<span class="built_in">strcmp</span>(scon, mycon)) &#123;</span><br><span class="line">            ERROR(<span class="string">"Warning!  Service %s needs a SELinux domain defined; please fix!\n"</span>, svc-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line">        freecon(mycon);</span><br><span class="line">        freecon(fcon);</span><br><span class="line">        <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"could not get context while starting '%s'\n"</span>, svc-&gt;name);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-2-3-fork子进程-exec"><a href="#2-2-3-fork子进程-exec" class="headerlink" title="2.2.3 fork子进程,exec"></a>2.2.3 fork子进程,exec</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="comment">//首先打印 服务启动日志</span></span><br><span class="line">NOTICE(<span class="string">"Starting service '%s'...\n"</span>, svc-&gt;name);</span><br><span class="line">	</span><br><span class="line"><span class="comment">//fork进程</span></span><br><span class="line"><span class="keyword">pid_t</span> pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socketinfo</span> *<span class="title">si</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcenvinfo</span> *<span class="title">ei</span>;</span></span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">int</span> fd, sz;</span><br><span class="line"></span><br><span class="line">    umask(<span class="number">077</span>);</span><br><span class="line">		</span><br><span class="line">    <span class="comment">//准备环境变量</span></span><br><span class="line">    <span class="keyword">if</span> (properties_initialized()) &#123;</span><br><span class="line">        get_property_workspace(&amp;fd, &amp;sz);</span><br><span class="line">        <span class="built_in">snprintf</span>(tmp, <span class="keyword">sizeof</span>(tmp), <span class="string">"%d,%d"</span>, dup(fd), sz);</span><br><span class="line">        add_environment(<span class="string">"ANDROID_PROPERTY_WORKSPACE"</span>, tmp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ei = svc-&gt;envvars; ei; ei = ei-&gt;next)</span><br><span class="line">        add_environment(ei-&gt;name, ei-&gt;value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果服务选项中有socket选项。这时候就开始创建参数中定义的socket。</span></span><br><span class="line">   <span class="keyword">for</span> (si = svc-&gt;sockets; si; si = si-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">int</span> socket_type = (</span><br><span class="line">                !<span class="built_in">strcmp</span>(si-&gt;type, <span class="string">"stream"</span>) ? SOCK_STREAM :</span><br><span class="line">                    (!<span class="built_in">strcmp</span>(si-&gt;type, <span class="string">"dgram"</span>) ? SOCK_DGRAM : SOCK_SEQPACKET));</span><br><span class="line">        <span class="keyword">int</span> s = create_socket(si-&gt;name, socket_type,</span><br><span class="line">                              si-&gt;perm, si-&gt;uid, si-&gt;gid, si-&gt;socketcon ?: scon);</span><br><span class="line">        <span class="keyword">if</span> (s &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            publish_socket(si-&gt;name, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    freecon(scon);</span><br><span class="line">    scon = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (svc-&gt;writepid_files_) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> pid_str = android::base::StringPrintf(<span class="string">"%d"</span>, pid);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; file : *svc-&gt;writepid_files_) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!android::base::WriteStringToFile(pid_str, file)) &#123;</span><br><span class="line">                ERROR(<span class="string">"couldn't write %s to %s: %s\n"</span>,</span><br><span class="line">                      pid_str.c_str(), file.c_str(), strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (svc-&gt;ioprio_class != IoSchedClass_NONE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (android_set_ioprio(getpid(), svc-&gt;ioprio_class, svc-&gt;ioprio_pri)) &#123;</span><br><span class="line">            ERROR(<span class="string">"Failed to set pid %d ioprio = %d,%d: %s\n"</span>,</span><br><span class="line">                  getpid(), svc-&gt;ioprio_class, svc-&gt;ioprio_pri, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">   <span class="comment">//处理标准输入 标准输出 标准错误3个文件描述符</span></span><br><span class="line">    <span class="keyword">if</span> (needs_console) &#123;</span><br><span class="line">        setsid();</span><br><span class="line">        open_console();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        zap_stdio();</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="comment">//这边明显不执行</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> n = <span class="number">0</span>; svc-&gt;args[n]; n++) &#123;</span><br><span class="line">            INFO(<span class="string">"args[%zu] = '%s'\n"</span>, n, svc-&gt;args[n]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> n = <span class="number">0</span>; ENV[n]; n++) &#123;</span><br><span class="line">            INFO(<span class="string">"env[%zu] = '%s'\n"</span>, n, ENV[n]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setpgid(<span class="number">0</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// As requested, set our gid, supplemental gids, and uid.</span></span><br><span class="line">    <span class="keyword">if</span> (svc-&gt;gid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (setgid(svc-&gt;gid) != <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"setgid failed: %s\n"</span>, strerror(errno));</span><br><span class="line">            _exit(<span class="number">127</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (svc-&gt;nr_supp_gids) &#123;</span><br><span class="line">        <span class="keyword">if</span> (setgroups(svc-&gt;nr_supp_gids, svc-&gt;supp_gids) != <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"setgroups failed: %s\n"</span>, strerror(errno));</span><br><span class="line">            _exit(<span class="number">127</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (svc-&gt;uid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (setuid(svc-&gt;uid) != <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"setuid failed: %s\n"</span>, strerror(errno));</span><br><span class="line">            _exit(<span class="number">127</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (svc-&gt;seclabel) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_selinux_enabled() &gt; <span class="number">0</span> &amp;&amp; setexeccon(svc-&gt;seclabel) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"cannot setexeccon('%s'): %s\n"</span>, svc-&gt;seclabel, strerror(errno));</span><br><span class="line">            _exit(<span class="number">127</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="comment">//执行exec</span></span><br><span class="line">    <span class="keyword">if</span> (!dynamic_args) &#123;</span><br><span class="line">        <span class="keyword">if</span> (execve(svc-&gt;args[<span class="number">0</span>], (<span class="keyword">char</span>**) svc-&gt;args, (<span class="keyword">char</span>**) ENV) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"cannot execve('%s'): %s\n"</span>, svc-&gt;args[<span class="number">0</span>], strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">char</span> *arg_ptrs[INIT_PARSER_MAXARGS+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> arg_idx = svc-&gt;nargs;</span><br><span class="line">        <span class="keyword">char</span> *tmp = strdup(dynamic_args);</span><br><span class="line">        <span class="keyword">char</span> *next = tmp;</span><br><span class="line">        <span class="keyword">char</span> *bword;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Copy the static arguments */</span></span><br><span class="line">        <span class="built_in">memcpy</span>(arg_ptrs, svc-&gt;args, (svc-&gt;nargs * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((bword = strsep(&amp;next, <span class="string">" "</span>))) &#123;</span><br><span class="line">            arg_ptrs[arg_idx++] = bword;</span><br><span class="line">            <span class="keyword">if</span> (arg_idx == INIT_PARSER_MAXARGS)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        arg_ptrs[arg_idx] = <span class="literal">NULL</span>;</span><br><span class="line">        execve(svc-&gt;args[<span class="number">0</span>], (<span class="keyword">char</span>**) arg_ptrs, (<span class="keyword">char</span>**) ENV);</span><br><span class="line">    &#125;</span><br><span class="line">    _exit(<span class="number">127</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="三-解析启动脚本init-rc"><a href="#三-解析启动脚本init-rc" class="headerlink" title="三. 解析启动脚本init.rc"></a>三. 解析启动脚本init.rc</h1><h1 id="3-1-init-rc文件格式"><a href="#3-1-init-rc文件格式" class="headerlink" title="3.1 init.rc文件格式"></a>3.1 init.rc文件格式</h1><p>init.rc文件是以块为单位，主要分为两类：</p>
<ul>
<li>动作:action,以on开头;</li>
<li>服务:service，以service开头。</li>
<li>选项:Options</li>
<li>命令:Commands<br>注释以#开头。无论是action还是service的执行顺序都不是以文件中的编排顺序执行的，<strong>执行与否和是否执行都是Init进程中决定的</strong>。</li>
</ul>
<h1 id="3-1-1-action"><a href="#3-1-1-action" class="headerlink" title="3.1.1 action"></a>3.1.1 action</h1><p>格式：<br>on [trigger] 触发条件<br>   [Command1]<br>   [Command2]<br>   [Command3]</p>
<p>在on后面紧跟的字符串是action的触发器，触发器后面的是命令列表，每一行都是一个命令。可以通过 trigger 触发器字符串（trigger late-init） 来触发。</p>
<p>当相应的事件发生后，系统会对rc文件中的各个 trigger 进行匹配，匹配到的action会被加入到 命令执行列表的尾部，已经在队伍中的action不会被重复添加。</p>
<p>触发器几种类别</p>
<ul>
<li>on early-init; 在初始化早期阶段触发；</li>
<li>on init; 在初始化阶段触发；</li>
<li>on late-init; 在初始化晚期阶段触发；</li>
<li>on boot/charger： 当系统启动/充电时触发，还包含其他情况，此处不一一列举；</li>
<li>on property:<key>=<value>: 当属性值满足条件时触发；</value></key></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">on property:sys.boot_from_charger_mode=1</span><br><span class="line">    class_stop charger</span><br><span class="line">    trigger late-init</span><br><span class="line"></span><br><span class="line"># Load properties from /system/ + /factory after fs mount.</span><br><span class="line">on load_system_props_action</span><br><span class="line">    load_system_props</span><br><span class="line"></span><br><span class="line">on load_persist_props_action</span><br><span class="line">    load_persist_props</span><br><span class="line">    start logd</span><br><span class="line">    start logd-reinit</span><br></pre></td></tr></table></figure>
<h1 id="3-1-2-service"><a href="#3-1-2-service" class="headerlink" title="3.1.2 service"></a>3.1.2 service</h1><p>格式：<br>service [name:名称] [pathname：路径] [argument：参数]<br>    [option]<br>    [option]</p>
<p>在service后面是服务的名称，我们可以使用“start”命令加服务名称来启动一个服务（start logd）。名称后面的则是执行文件路径和执行参数。然后下面的行称为选项，每一行都是一个选项。例如class表示服务的类别，我们可以通过class_start来一次性启动一组服务。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">service ueventd /sbin/ueventd</span><br><span class="line">    class core</span><br><span class="line">    critical</span><br><span class="line">    seclabel u:r:ueventd:s0</span><br><span class="line"></span><br><span class="line">service logd /system/bin/logd</span><br><span class="line">    class core</span><br><span class="line">    socket logd stream 0666 logd logd</span><br><span class="line">    socket logdr seqpacket 0666 logd logd</span><br><span class="line">    socket logdw dgram 0222 logd logd</span><br><span class="line">    group root system</span><br><span class="line">     writepid /dev/cpuset/system-background/tasks</span><br><span class="line"></span><br><span class="line">service logd-reinit /system/bin/logd --reinit</span><br><span class="line">    oneshot</span><br><span class="line">    writepid /dev/cpuset/system-background/tasks</span><br><span class="line">    disabled</span><br><span class="line"></span><br><span class="line">service healthd /sbin/healthd</span><br><span class="line">    class core</span><br><span class="line">    critical</span><br><span class="line">    seclabel u:r:healthd:s0</span><br><span class="line">    group root system</span><br><span class="line"></span><br><span class="line">service console /system/bin/sh</span><br><span class="line">    class core</span><br><span class="line">    console</span><br><span class="line">    disabled</span><br><span class="line">    user shell</span><br><span class="line">    group shell log</span><br><span class="line">    seclabel u:r:shell:s0</span><br></pre></td></tr></table></figure></p>
<h1 id="3-1-3-Options-选项"><a href="#3-1-3-Options-选项" class="headerlink" title="3.1.3 Options 选项"></a>3.1.3 Options 选项</h1><p>选项是service的修订项，它决定了服务何时运行以及怎么运行。</p>
<ul>
<li><p>disabled: 表示不能通过触发器来触发，只能根据start service名开启动；</p>
</li>
<li><p>oneshot: service退出后不再重启；</p>
</li>
<li><p>user/group： 设置执行服务的用户/用户组，默认都是root；</p>
</li>
<li><p>class：设置所属的类名，当所属类启动/退出时，服务也启动/停止，默认为default；</p>
</li>
<li><p>onrestart:当服务重启时执行相应命令；</p>
</li>
<li><p>socket: 创建名为/dev/socket/<name>的socket，并把<strong>文件描述符</strong>传递给要启动的进程。</name></p>
</li>
<li><p>critical:这是一个关键服务，如果在4分钟内重启启动4次，则系统会重启并进入Recovery模式。</p>
</li>
</ul>
<h1 id="3-1-4-Commands-命令"><a href="#3-1-4-Commands-命令" class="headerlink" title="3.1.4 Commands 命令"></a>3.1.4 Commands 命令</h1><ul>
<li><p>class_start &lt;service_class_name&gt;： 启动属于同一个class的所有服务；</p>
</li>
<li><p>start &lt;service_name&gt;： 启动指定的服务，若已启动则跳过；</p>
</li>
<li><p>stop &lt;service_name&gt;： 停止正在运行的服务</p>
</li>
<li><p>setprop <name> <value>：设置属性值</value></name></p>
</li>
<li><p>mkdir <path></path>：创建指定目录</p>
</li>
<li><p>symlink <target> &lt;sym_link&gt;： 创建连接到<target>的&lt;sym_link&gt;符号链接；</target></target></p>
</li>
<li><p>write <path></path> <string>： 向文件path中写入字符串；</string></p>
</li>
<li><p>exec： fork并执行，会阻塞init进程直到程序完毕；</p>
</li>
<li><p>exprot <name> <name>：设定环境变量；</name></name></p>
</li>
<li><p>loglevel <level>：设置log级别</level></p>
</li>
</ul>
<p>commands的命令远不止上面这些，这里只是列出一些常用的命令。</p>
<h1 id="3-2-脚本文件解析过程"><a href="#3-2-脚本文件解析过程" class="headerlink" title="3.2 脚本文件解析过程"></a>3.2 脚本文件解析过程</h1><p>下面我们来追踪下脚本文件的解析过程</p>
<blockquote>
<p>源码所在文件路径如下<br>\system\core\init\init_parser.cpp</p>
</blockquote>
<p>首先从入口函数开始</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_parse_config_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* path)</span> </span>&#123;</span><br><span class="line">    INFO(<span class="string">"Parsing %s...\n"</span>, path);</span><br><span class="line">    Timer t;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> data;</span><br><span class="line">    <span class="keyword">if</span> (!read_file(path, &amp;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data.push_back(<span class="string">'\n'</span>); <span class="comment">// <span class="doctag">TODO:</span> fix parse_config.</span></span><br><span class="line">    parse_config(path, data);</span><br><span class="line">    dump_parser_state();</span><br><span class="line"></span><br><span class="line">    NOTICE(<span class="string">"(Parsing %s took %.2fs.)\n"</span>, path, t.duration());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的函数可以看出来，首先通过read_file将文件的内容读到内存中，然后再通过parse_config函数进行解析。下面我们继续来追踪parse_config的方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parse_config</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fn, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listnode</span> <span class="title">import_list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listnode</span> *<span class="title">node</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *args[INIT_PARSER_MAXARGS];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> nargs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    parse_state state;</span><br><span class="line">    state.filename = fn;</span><br><span class="line">    state.line = <span class="number">0</span>;</span><br><span class="line">    state.ptr = strdup(data.c_str());  <span class="comment">// <span class="doctag">TODO:</span> fix this code!</span></span><br><span class="line">    state.nexttoken = <span class="number">0</span>;</span><br><span class="line">    state.parse_line = parse_line_no_op;</span><br><span class="line"></span><br><span class="line">    list_init(&amp;import_list);</span><br><span class="line">    state.priv = &amp;import_list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (next_token(&amp;state)) &#123;</span><br><span class="line">		<span class="comment">//如果是结束标识符，则跳转到下面的parser_done位置</span></span><br><span class="line">        <span class="keyword">case</span> T_EOF:</span><br><span class="line">            state.parse_line(&amp;state, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">goto</span> parser_done;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//行结束符</span></span><br><span class="line">        <span class="keyword">case</span> T_NEWLINE:</span><br><span class="line">            state.line++;</span><br><span class="line">            <span class="keyword">if</span> (nargs) &#123;</span><br><span class="line">                <span class="keyword">int</span> kw = lookup_keyword(args[<span class="number">0</span>]);</span><br><span class="line">				<span class="comment">//判断是否是section：关键字 on service import</span></span><br><span class="line">                <span class="keyword">if</span> (kw_is(kw, SECTION)) &#123;</span><br><span class="line">                    state.parse_line(&amp;state, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">					<span class="comment">//具体处理见 3.2.1 </span></span><br><span class="line">                    parse_new_section(&amp;state, kw, nargs, args);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">//当作当前section所属行处理</span></span><br><span class="line">                    state.parse_line(&amp;state, nargs, args);</span><br><span class="line">                &#125;</span><br><span class="line">                nargs = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//单词结束符 则先放入到数组中</span></span><br><span class="line">        <span class="keyword">case</span> T_TEXT:</span><br><span class="line">            <span class="keyword">if</span> (nargs &lt; INIT_PARSER_MAXARGS) &#123;</span><br><span class="line">                args[nargs++] = state.text;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">parser_done:</span><br><span class="line">    list_for_each(node, &amp;import_list) &#123;</span><br><span class="line">         <span class="class"><span class="keyword">struct</span> <span class="title">import</span> *<span class="title">import</span> = <span class="title">node_to_item</span>(<span class="title">node</span>, <span class="title">struct</span> <span class="title">import</span>, <span class="title">list</span>);</span></span><br><span class="line">         <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">         ret = init_parse_config_file(<span class="keyword">import</span>-&gt;filename);</span><br><span class="line">         <span class="keyword">if</span> (ret)</span><br><span class="line">             ERROR(<span class="string">"could not import file '%s' from '%s'\n"</span>,</span><br><span class="line">                   <span class="keyword">import</span>-&gt;filename, fn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>parse_new_section方法追踪</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parse_new_section</span><span class="params">(struct parse_state *state, <span class="keyword">int</span> kw,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> nargs, <span class="keyword">char</span> **args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[ %s %s ]\n"</span>, args[<span class="number">0</span>],</span><br><span class="line">           nargs &gt; <span class="number">1</span> ? args[<span class="number">1</span>] : <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">switch</span>(kw) &#123;</span><br><span class="line">    <span class="keyword">case</span> K_service:</span><br><span class="line">        state-&gt;context = parse_service(state, nargs, args);</span><br><span class="line">        <span class="keyword">if</span> (state-&gt;context) &#123;</span><br><span class="line">            state-&gt;parse_line = parse_line_service;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> K_on:</span><br><span class="line">        state-&gt;context = parse_action(state, nargs, args);</span><br><span class="line">        <span class="keyword">if</span> (state-&gt;context) &#123;</span><br><span class="line">            state-&gt;parse_line = parse_line_action;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> K_import:</span><br><span class="line">        parse_import(state, nargs, args);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    state-&gt;parse_line = parse_line_no_op;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面的函数可以看出，该方法通过传入的参数kw来决定用什么方法来处理：</p>
<ul>
<li>on关键字：parse_action</li>
<li>service关键字：parse_service</li>
<li>import关键字：parse_action</li>
</ul>
<p>然后我们可以看出上面对结构体state的parse_line字段分别进行赋值了方法地址,该方法用来解析命令行。</p>
<ul>
<li>on关键字：parse_line_action</li>
<li>service关键字：parse_line_service</li>
</ul>
<h1 id="3-3-执行action"><a href="#3-3-执行action" class="headerlink" title="3.3 执行action"></a>3.3 执行action</h1><p>3.2的解析过程只是将init.rc中的action和service添加到各自的列表中。真正将它们添加到执行列表的还是在init进程中处理的。上文2.1.11 中在init的初始化过程通过action_for_each_trigger将action添加到action_queue中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">action_for_each_trigger</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *trigger,</span></span></span><br><span class="line">                             void (*func)(struct action *act))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listnode</span> *<span class="title">node</span>, *<span class="title">node2</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">action</span> *<span class="title">act</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">trigger</span> *<span class="title">cur_trigger</span>;</span></span><br><span class="line"></span><br><span class="line">    list_for_each(node, &amp;action_list) &#123;</span><br><span class="line">        act = node_to_item(node, struct action, alist);</span><br><span class="line">        list_for_each(node2, &amp;act-&gt;triggers) &#123;</span><br><span class="line">            cur_trigger = node_to_item(node2, struct trigger, nlist);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur_trigger-&gt;name, trigger)) &#123;</span><br><span class="line">                func(act);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="四-Init进程对信号的处理"><a href="#四-Init进程对信号的处理" class="headerlink" title="四.Init进程对信号的处理"></a>四.Init进程对信号的处理</h1><h1 id="4-1-僵尸进程"><a href="#4-1-僵尸进程" class="headerlink" title="4.1 僵尸进程"></a>4.1 僵尸进程</h1><p>当一个进程退出exit()时，会向它的父进程发送一个SIGCHLD信号。父进程收到该信号后，会释放分配给该子进程的系统资源；并且父进程需要调用wait()或waitpid()等待子进程结束。</p>
<p>如果父进程没有做这种处理，且父进程初始化时也没有调用signal(SIGCHLD, SIG_IGN)来显示忽略对SIGCHLD的处理，这时子进程将一直保持当前的退出状态，不会完全退出。这样的子进程不能被调度，所做的只是在进程列表中占据一个位置，保存了该进程的PID、终止状态、CPU使用时间等信息；我们将这种进程称为“Zombie”进程，即僵尸进程。</p>
<p>android中查看僵尸进程的方法是通过 adb shell ps来查看的，僵尸进程的的进程状态为“Z”。</p>
<p>由于僵尸进程仍会在进程列表中占据一个位置，而Linux所支持的最大进程数量是有限的；超过这个界限值后，我们就无法创建进程。所以，我们有必要清理那些僵尸进程，以保证系统的正常运作。</p>
<h1 id="4-2-处理过程"><a href="#4-2-处理过程" class="headerlink" title="4.2 处理过程"></a>4.2 处理过程</h1><p>待补充</p>
<h1 id="五-属性系统"><a href="#五-属性系统" class="headerlink" title="五. 属性系统"></a>五. 属性系统</h1><h1 id="5-1-属性系统介绍"><a href="#5-1-属性系统介绍" class="headerlink" title="5.1 属性系统介绍"></a>5.1 属性系统介绍</h1><p>android的属性用来保存系统设置和进程间传递一些信息。每个属性由属性名称和属性值组成，名称通常以“.”分割,这些名称的前缀有特殊的含义，不能随便改动。属性值只能是字符串。</p>
<p>对于进程来说，读取属性值是没有限制的，任何进程都可以读取属性值。但是写属性值只能通过init进程进行，而且init进程还会检查请求的进程是否具有该权限（5.0以后只在）。当属性值修改成功后，init进程会init.rc中是否有跟该属性修改值相匹配的“触发器”。如果有则执行触发器下的命令。</p>
<p>前缀分类</p>
<ul>
<li><p>“ro.”：表示只读属性，一旦设置则不能改变。</p>
</li>
<li><p>“persist”:表示属性值会被写入目录/data/property下与属性同名的文件中。下次开机init进程会从中读取值。所以这边设置的值是永久生效的。</p>
</li>
<li><p>“ctl”:表示控制信息，用来执行一些命令：ctl.start、ctl.stop、ctl.restart</p>
<ul>
<li>setprop ctl.start bootanim：查看开机动画</li>
<li>setprop ctl.stop bootanim：关闭开机动画</li>
<li>setprop ctl.start pre-recovery：进入recovery模式</li>
</ul>
</li>
</ul>
<h1 id="5-2-创建属性系统的共享空间"><a href="#5-2-创建属性系统的共享空间" class="headerlink" title="5.2 创建属性系统的共享空间"></a>5.2 创建属性系统的共享空间</h1><p>在上面Init进程的初始化函数中我们调用了property_init函数为属性系统创建了一块共享内存区域。这块区域只能由init进程进行写入，读则不限制。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">property_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//防止多次初始化</span></span><br><span class="line">    <span class="keyword">if</span> (property_area_initialized) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_area_initialized = <span class="literal">true</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//创建和初始化属性的共享内存空间，这块内存空间由/dev/__properties__ 设备创建,这块空间的文件描述符保存在</span></span><br><span class="line">	<span class="comment">//static workspace pa_workspace; 中，最后在service_start的时候保存到环境变量中</span></span><br><span class="line">    <span class="keyword">if</span> (__system_property_area_init()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pa_workspace.size = <span class="number">0</span>;</span><br><span class="line">    pa_workspace.fd = open(PROP_FILENAME, O_RDONLY | O_NOFOLLOW | O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (pa_workspace.fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        ERROR(<span class="string">"Failed to open %s: %s\n"</span>, PROP_FILENAME, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-3-初始化属性系统的值"><a href="#5-3-初始化属性系统的值" class="headerlink" title="5.3 初始化属性系统的值"></a>5.3 初始化属性系统的值</h1><p>通过从以下文件中读取值进行初始化</p>
<p>/system/build.prop：定了系统初始和永久的一些属性<br>/data/local.prop：这个则需要和ro.debuggable配合使用，如果这个值为1，那么从该文件中读取值覆盖系统缺省的属性值，之所有有这个设计是为了方便开发人员调试，因为/system/build.prop 是在根目录下的。<br>/data/property：该目录下的文件读取出来写入到属性值中。<br>/default.prop: Init进程初始化过程中调用property_load_boot_defaults函数读取的</p>
<h1 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h1><blockquote>
<p>本文源码基于android6.0<br>system\core\init\init.cpp<br>system\core\init\init_parser.cpp<br>system\core\init\signal_handler.cpp<br>system\core\init\property_service.cpp</p>
</blockquote>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/30/android6.0/PKMS/开机应用扫描流程/" rel="next" title="开机应用扫描流程">
                <i class="fa fa-chevron-left"></i> 开机应用扫描流程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/01/Zygote进程/" rel="prev" title="Zygote进程">
                Zygote进程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="道墟" />
            
              <p class="site-author-name" itemprop="name">道墟</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">Kategorien</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">Tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-概述"><span class="nav-text">一.概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-Init进程的初始化过程"><span class="nav-text">二.Init进程的初始化过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-main函数的流程"><span class="nav-text">2.1 main函数的流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-1-选择启动程序"><span class="nav-text">2.1.1 选择启动程序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-2-设置进程创建的文件的属性"><span class="nav-text">2.1.2 设置进程创建的文件的属性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-3-创建目录和挂载文件系统"><span class="nav-text">2.1.3 创建目录和挂载文件系统</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-4-初始化log系统"><span class="nav-text">2.1.4 初始化log系统</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-5-初始化属性系统"><span class="nav-text">2.1.5 初始化属性系统</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-6-初始化SELinux内核"><span class="nav-text">2.1.6 初始化SELinux内核</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-7-初始化子进程退出的信号处理过程"><span class="nav-text">2.1.7 初始化子进程退出的信号处理过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-8-设置系统属性的默认值"><span class="nav-text">2.1.8 设置系统属性的默认值</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-9-启动属性服务（sockect）"><span class="nav-text">2.1.9 启动属性服务（sockect）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-10-解析init-rc文件"><span class="nav-text">2.1.10 解析init.rc文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-11-初始化执行列表action-queue"><span class="nav-text">2.1.11 初始化执行列表action_queue</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-12-无限循环执行"><span class="nav-text">2.1.12 无限循环执行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-2-启动Service进程"><span class="nav-text">2.2 启动Service进程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-2-1-重置Service结构中的标志和可执行判断"><span class="nav-text">2.2.1 重置Service结构中的标志和可执行判断</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-2-2-设置安全上下文"><span class="nav-text">2.2.2 设置安全上下文</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-2-3-fork子进程-exec"><span class="nav-text">2.2.3 fork子进程,exec</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三-解析启动脚本init-rc"><span class="nav-text">三. 解析启动脚本init.rc</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-1-init-rc文件格式"><span class="nav-text">3.1 init.rc文件格式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-1-1-action"><span class="nav-text">3.1.1 action</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-1-2-service"><span class="nav-text">3.1.2 service</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-1-3-Options-选项"><span class="nav-text">3.1.3 Options 选项</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-1-4-Commands-命令"><span class="nav-text">3.1.4 Commands 命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-2-脚本文件解析过程"><span class="nav-text">3.2 脚本文件解析过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-3-执行action"><span class="nav-text">3.3 执行action</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四-Init进程对信号的处理"><span class="nav-text">四.Init进程对信号的处理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-1-僵尸进程"><span class="nav-text">4.1 僵尸进程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-2-处理过程"><span class="nav-text">4.2 处理过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五-属性系统"><span class="nav-text">五. 属性系统</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-1-属性系统介绍"><span class="nav-text">5.1 属性系统介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-2-创建属性系统的共享空间"><span class="nav-text">5.2 创建属性系统的共享空间</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-3-初始化属性系统的值"><span class="nav-text">5.3 初始化属性系统的值</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#源码地址"><span class="nav-text">源码地址</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">道墟</span>

  

  
</div>




  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
