<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="一.背景知识1.1 android权限分级在android开发中权限主要分为以下四级  normal: 普通的权限，只需要在 AndroidManifest.xml 文件中定义就可以使用。 dangerous: 危险的权限，不仅需要在 AndroidManifest.xml 文件定义，如果apk的目标版本是23以上并且运行在23版本以上的机子上那么需要动态申请权限。 signature: 系统级别">
<meta property="og:type" content="article">
<meta property="og:title" content="日常问题:自定义系统权限级签名">
<meta property="og:url" content="http://yoursite.com/2018/06/08/日常问题-自定义系统权限级签名/index.html">
<meta property="og:site_name" content="道墟">
<meta property="og:description" content="一.背景知识1.1 android权限分级在android开发中权限主要分为以下四级  normal: 普通的权限，只需要在 AndroidManifest.xml 文件中定义就可以使用。 dangerous: 危险的权限，不仅需要在 AndroidManifest.xml 文件定义，如果apk的目标版本是23以上并且运行在23版本以上的机子上那么需要动态申请权限。 signature: 系统级别">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-06-11T07:54:14.923Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="日常问题:自定义系统权限级签名">
<meta name="twitter:description" content="一.背景知识1.1 android权限分级在android开发中权限主要分为以下四级  normal: 普通的权限，只需要在 AndroidManifest.xml 文件中定义就可以使用。 dangerous: 危险的权限，不仅需要在 AndroidManifest.xml 文件定义，如果apk的目标版本是23以上并且运行在23版本以上的机子上那么需要动态申请权限。 signature: 系统级别">






  <link rel="canonical" href="http://yoursite.com/2018/06/08/日常问题-自定义系统权限级签名/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>日常问题:自定义系统权限级签名 | 道墟</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">道墟</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">初九，潜龙勿用</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Startseite</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archiv</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/08/日常问题-自定义系统权限级签名/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="道墟">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="道墟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">日常问题:自定义系统权限级签名
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-06-08 15:09:53" itemprop="dateCreated datePublished" datetime="2018-06-08T15:09:53+08:00">2018-06-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Updated at: 2018-06-11 15:54:14" itemprop="dateModified" datetime="2018-06-11T15:54:14+08:00">2018-06-11</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="一-背景知识"><a href="#一-背景知识" class="headerlink" title="一.背景知识"></a>一.背景知识</h1><h1 id="1-1-android权限分级"><a href="#1-1-android权限分级" class="headerlink" title="1.1 android权限分级"></a>1.1 android权限分级</h1><p>在android开发中权限主要分为以下四级</p>
<ul>
<li>normal: 普通的权限，只需要在 AndroidManifest.xml 文件中定义就可以使用。</li>
<li>dangerous: 危险的权限，不仅需要在 AndroidManifest.xml 文件定义，如果apk的目标版本是23以上并且运行在23版本以上的机子上那么需要动态申请权限。</li>
<li>signature: 系统级别签名才能获取的权限。</li>
<li>signature|system: 系统级别签名或者系统应用可以获取的权限。</li>
</ul>
<blockquote>
<p>关于权限定义的源文件位于：frameworks\base\core\res\AndroidManifest.xml</p>
</blockquote>
<p>这边要注意 系统权限应用(signature)和系统应用（system）的区别：<br>系统应用一般是厂商内置的应用，在目录 system/app 、/system/framework/、/vendor/app/下的都是系统应用，<br>系统权限应用是 指在 AndroidManifest.xml 申请了 android:sharedUserId=”android.uid.system” 的应用，而这个是需要系统签名的。<br>这部分的知识在PKMS服务中会详细的介绍。</p>
<h1 id="1-2-系统签名类型"><a href="#1-2-系统签名类型" class="headerlink" title="1.2 系统签名类型"></a>1.2 系统签名类型</h1><p>android的标准签名key有：</p>
<ul>
<li><p>testkey: testkey是作为android编译的时候默认的签名key，如果系统中的apk的android.mk中没有设置LOCAL_CERTIFICATE的值，就默认使用testkey</p>
</li>
<li><p>media：如果LOCAL_CERTIFICATE := media 就代表使用 media 来签名，这样apk就会跟系统中所有使用android.uid.media共享UID。用这个是该APK是media/download系统中的一环。</p>
</li>
<li><p>platform: 如果LOCAL_CERTIFICATE := platform 就代表使用platform来签名，这样的话这个apk就拥有了和system相同的签名，因为系统级别的签名也是使用的platform来签名</p>
</li>
<li><p>shared：如果LOCAL_CERTIFICATE := shared 就代表使用 shared 来签名，这样apk就会跟系统中所有使用android.uid.shared共享UID。用这个的一般是该APK需要和home/contacts进程共享数据。</p>
</li>
</ul>
<p>在源码的/build/target/product/security里面看到对应的密钥，其中.pk8代表私钥，.pem公钥，一定是成对出现的。</p>
<p>查看.pem公钥方法<br>openssl x509 -in cert.pem(文件名) -noout -text</p>
<p>关于.pk8和.pem在下面会继续详细介绍。</p>
<h1 id="1-3-签名相关知识"><a href="#1-3-签名相关知识" class="headerlink" title="1.3 签名相关知识"></a>1.3 签名相关知识</h1><h1 id="1-3-1-数据摘要"><a href="#1-3-1-数据摘要" class="headerlink" title="1.3.1 数据摘要"></a>1.3.1 数据摘要</h1><p>消息摘要算法（Message Digest Algorithm）是一种能产生特殊输出格式的算法，其原理是根据一定的运算规则对原始数据进行某种形式的信息提取，被提取出的信息就被称作原始数据的消息摘要。简单点说就是提取数据的“指纹”。</p>
<p>著名的摘要算法有RSA公司的MD5算法和SHA-1算法及其大量的变体。</p>
<p>消息摘要的主要特点有：</p>
<p>1）无论输入的消息有多长，计算出来的消息摘要的长度总是固定的。例如应用MD5算法摘要的消息有128个比特位，用SHA-1算法摘要的消息最终有160比特位的输出<br>。<br>2）一般来说（不考虑碰撞的情况下），只要输入的原始数据不同，对其进行摘要以后产生的消息摘要也必不相同，即使原始数据稍有改变，输出的消息摘要便完全不同。但是，相同的输入必会产生相同的输出。</p>
<p>3）具有不可逆性，即只能进行正向的信息摘要，而无法从摘要中恢复出任何的原始消息。</p>
<h1 id="1-3-2-jarsign和signapk工具"><a href="#1-3-2-jarsign和signapk工具" class="headerlink" title="1.3.2 jarsign和signapk工具"></a>1.3.2 jarsign和signapk工具</h1><p>这两个都是android系统中使用的签名工具。jarsign是Java本生自带的一个工具，他可以对jar进行签名的。而signapk是后面专门为了Android应用程序apk进行签名的工具，他们两的签名算法没什么区别，主要是签名时使用的文件不一样。</p>
<ul>
<li><p>jarsign工具 签名时使用的是 keystore 文件。</p>
</li>
<li><p>signapk工具 签名时使用的是pk8、pem文件。</p>
</li>
<li><p>keystore 文件 和 pk8、pem文件 是可以转化的，在开发具有系统权限的应用的时候我们一般是将pk8、pem文件转化成keystore 文件，然后再在AS中设置调试编译打包使用的keystore 文件，这样就可以像开发普通应用一样去开发具有系统权限的应用，而不是每次打包后再用signapk工具重新签名。</p>
</li>
</ul>
<blockquote>
<p>这边补充下：keystore 是Eclipse 打包生成的签名。 而 。jks是Android  studio 生成的签名！都是用来打包的，并保证应用的唯一性，它们是可以互相转换的。</p>
</blockquote>
<p>因为我们现在常用的是jks文件，可以通过代码获取jks文件的公钥和私钥信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStoreException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.UnrecoverableKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.security.cert.Certificate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JKSTesting</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PublicKey <span class="title">getPublicKey</span><span class="params">(String keyStoreFile,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         String storeFilePass, String keyAlias)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取密钥是所要用到的工具类</span></span><br><span class="line">        KeyStore ks;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 公钥类所对应的类</span></span><br><span class="line">        PublicKey pubkey = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 得到实例对象</span></span><br><span class="line">            ks = KeyStore.getInstance(<span class="string">"JKS"</span>);</span><br><span class="line">            FileInputStream fin;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 读取JKS文件</span></span><br><span class="line">                fin = <span class="keyword">new</span> FileInputStream(keyStoreFile);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 读取公钥</span></span><br><span class="line">                    ks.load(fin, storeFilePass.toCharArray());</span><br><span class="line">                    java.security.cert.Certificate cert = ks</span><br><span class="line">                            .getCertificate(keyAlias);</span><br><span class="line">                    pubkey = cert.getPublicKey();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeyStoreException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pubkey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 得到私钥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyStoreFile</span></span><br><span class="line"><span class="comment">     *            私钥文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> storeFilePass</span></span><br><span class="line"><span class="comment">     *            私钥文件的密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyAlias</span></span><br><span class="line"><span class="comment">     *            别名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyAliasPass</span></span><br><span class="line"><span class="comment">     *            密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PrivateKey <span class="title">getPrivateKey</span><span class="params">(String keyStoreFile,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           String storeFilePass, String keyAlias, String keyAliasPass)</span> </span>&#123;</span><br><span class="line">        KeyStore ks;</span><br><span class="line">        PrivateKey prikey = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ks = KeyStore.getInstance(<span class="string">"JKS"</span>);</span><br><span class="line">            FileInputStream fin;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fin = <span class="keyword">new</span> FileInputStream(keyStoreFile);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ks.load(fin, storeFilePass.toCharArray());</span><br><span class="line">                        <span class="comment">// 先打开文件</span></span><br><span class="line">                        prikey = (PrivateKey) ks.getKey(keyAlias, keyAliasPass</span><br><span class="line">                                .toCharArray());</span><br><span class="line">                        <span class="comment">// 通过别名和密码得到私钥</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (UnrecoverableKeyException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeyStoreException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> prikey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        PublicKey publicKey;</span><br><span class="line">        PrivateKey privateKey;</span><br><span class="line"></span><br><span class="line">        publicKey=getPublicKey(<span class="string">"*******"</span>,<span class="string">"*******"</span>, <span class="string">"*******"</span>);</span><br><span class="line">        privateKey=getPrivateKey(<span class="string">"*******"</span>,<span class="string">"*******"</span>, <span class="string">"*******"</span>,<span class="string">"*******"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"publicKey"</span>);</span><br><span class="line">        System.out.println(publicKey.toString());</span><br><span class="line">        System.out.println(<span class="string">"privateKey"</span>);</span><br><span class="line">        System.out.println(privateKey.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="1-3-3-签名后生成的文件"><a href="#1-3-3-签名后生成的文件" class="headerlink" title="1.3.3 签名后生成的文件"></a>1.3.3 签名后生成的文件</h1><p>解压签名后的apk文件，在 META-INF 文件夹中可以看到以下格式的文件</p>
<ul>
<li>.RSA或者DSA</li>
<li>.SF</li>
<li>MANIFEST.MF文件</li>
</ul>
<p>Android中是允许使用多个 keystore 对apk进行签名的，这样在 META-INF 就会生成多对（.RSA和.SF）的文件，以 keystore 文件的 alias 的值为名称。如果是用 signapk工具 进行签名的话就会直接固定命名CERT。</p>
<h1 id="1-3-3-1-MANIFEST-MF文件"><a href="#1-3-3-1-MANIFEST-MF文件" class="headerlink" title="1.3.3.1 MANIFEST.MF文件"></a>1.3.3.1 MANIFEST.MF文件</h1><p>我们先看下这个文件的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Name: lombok/installer/InstallerGUI$4.SCL.lombok</span><br><span class="line">SHA1-Digest: ZSCgYd7ezY8EyCteY5YFVNSzqbg=</span><br><span class="line"></span><br><span class="line">Name: res/drawable-hdpi-v4/modify_phone_num_step_first.png</span><br><span class="line">SHA1-Digest: 1A/23eA5r36ww5luAwlaK5n42fc=</span><br><span class="line"></span><br><span class="line">Name: res/drawable-hdpi-v4/right_kuohao_focus.png</span><br><span class="line">SHA1-Digest: fPzTTOc+c1ogDOlHKpeJ0JGDt6U=</span><br><span class="line"></span><br><span class="line">Name: res/layout/activity_modify_phone.xml</span><br><span class="line">SHA1-Digest: aE+Ctjnxcu/xHp79HhRZ8LvnA/c=</span><br><span class="line"></span><br><span class="line">Name: res/drawable-1920x1080/item_h_default.png</span><br><span class="line">SHA1-Digest: KA0HpPJUVaKTpTnF5ouiJmRNyXo=</span><br><span class="line"></span><br><span class="line">Name: lombok/delombok/LombokOptionsFactory$1.SCL.lombok</span><br><span class="line">SHA1-Digest: QlP0zlFTJ9scHtfLL3/OZNhA2uw=</span><br><span class="line"></span><br><span class="line">Name: AndroidManifest.xml</span><br><span class="line">SHA1-Digest: lkuasUmz9QVhBrAh8JEMmyvL65c=</span><br><span class="line"></span><br><span class="line">Name: lombok/installer/InstallerGUI$9.SCL.lombok</span><br><span class="line">SHA1-Digest: ifEHckOynWf1wUlfPH/aoj73utk=</span><br><span class="line"></span><br><span class="line">Name: lombok/core/LombokConfiguration.SCL.lombok</span><br><span class="line">SHA1-Digest: XOaLbgugkPhHqkxGiDFxUvxNJSA=</span><br><span class="line"></span><br><span class="line">Name: lombok/installer/eclipse/JbdsLocationProvider.SCL.lombok</span><br><span class="line">SHA1-Digest: 3M+Q/7s7VwuoOWk1hpUJe8yBJjM=</span><br><span class="line"></span><br><span class="line">Name: res/drawable-hdpi-v4/user_prog_entry_layer.png</span><br><span class="line">SHA1-Digest: 5oJ0Hv4o+c7PkwJ4MOox2/xZmzU=</span><br></pre></td></tr></table></figure>
<p>文件的内容是逐一遍历apk里面的所有条目，如果是目录就跳过，如果是一个文件，就用SHA1（或者SHA256）消息摘要算法提取出该文件的摘要然后进行BASE64编码后，作为“SHA1-Digest”属性的值写入到MANIFEST.MF文件中的一个块中。该块有一个“Name”属性，其值就是该文件在apk包中的路径。</p>
<h1 id="1-3-3-2-SF文件"><a href="#1-3-3-2-SF文件" class="headerlink" title="1.3.3.2 SF文件"></a>1.3.3.2 SF文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Signature-Version: 1.0</span><br><span class="line">X-Android-APK-Signed: 2</span><br><span class="line">SHA1-Digest-Manifest: oZ0/oKbtbxza48iz2t1zT9MQ/vw=</span><br><span class="line">Created-By: 1.0 (Android)</span><br><span class="line"></span><br><span class="line">Name: res/layout/play_progress_tip_layout.xml</span><br><span class="line">SHA1-Digest: zGKChGzCciVxMBfsf/9QS1jA9f0=</span><br><span class="line"></span><br><span class="line">Name: res/anim/boot_one_circle.xml</span><br><span class="line">SHA1-Digest: P4oLIBrBAQqjEn2VUDXvvuYXfeI=</span><br><span class="line"></span><br><span class="line">Name: res/drawable-hdpi-v4/myapp_del_no_focus.png</span><br><span class="line">SHA1-Digest: GEyz0DWb4vzq33MLCBnxtTVbWQE=</span><br><span class="line"></span><br><span class="line">Name: lombok/eclipse/handlers/HandleLog$LoggingFramework.SCL.lombok</span><br><span class="line">SHA1-Digest: LSHMxv3Atl0Z7MCQaPf9yKvhax4=</span><br><span class="line"></span><br><span class="line">Name: lombok/delombok/DelombokApp$1.SCL.lombok</span><br><span class="line">SHA1-Digest: DfUlhS1EZ55lpPpz+vsDIf847No=</span><br></pre></td></tr></table></figure>
<p>SF文件记载的内容：</p>
<ul>
<li>计算这个MANIFEST.MF文件的整体SHA1值，再经过BASE64编码后，记录在CERT.SF主属性块（在文件头上）的“SHA1-Digest-Manifest”属性值值下</li>
<li>逐条计算MANIFEST.MF文件中每一个块的SHA1，并经过BASE64编码后，记录在CERT.SF中的同名块中，属性的名字是“SHA1-Digest</li>
</ul>
<h1 id="1-3-3-3-RSA文件"><a href="#1-3-3-3-RSA文件" class="headerlink" title="1.3.3.3 RSA文件"></a>1.3.3.3 RSA文件</h1><p>因为RSA文件加密了，所以我们需要用openssl命令才能查看其内容</p>
<blockquote>
<p>openssl pkcs7 -inform DER -in CERT.RSA(文件名) -noout -print_certs –text</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)       //版本号</span><br><span class="line">        Serial Number: 610763924 (0x24678494) //证书序列号</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption    //算法</span><br><span class="line">        Issuer: CN=icntv							//发行者名称</span><br><span class="line">        Validity									</span><br><span class="line">            Not Before: Nov  5 15:43:01 2012 GMT		//生效日期</span><br><span class="line">            Not After : Oct 12 15:43:01 2112 GMT		//终止日期</span><br><span class="line">        Subject: CN=icntv								//主体名称</span><br><span class="line">		//算法 参数 秘钥:主体公钥信息，包含开发者的加密算法以及密钥信息</span><br><span class="line">        Subject Public Key Info:						</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:80:03:44:30:c7:6a:93:e3:3a:94:8e:b6:a8:70:</span><br><span class="line">                    e0:19:eb:00:de:85:a9:b8:57:b9:e5:2e:0a:db:c0:</span><br><span class="line">                    1b:e4:56:c0:32:7c:f3:54:65:ca:20:02:df:6c:3b:</span><br><span class="line">                    f6:7e:29:71:3d:aa:69:ac:e9:61:17:65:9c:9b:94:</span><br><span class="line">                    74:40:a2:67:f8:65:26:2c:a0:cf:2a:2e:15:7d:04:</span><br><span class="line">                    c2:c2:44:d7:28:8a:c0:a7:65:ac:e5:eb:c6:67:ce:</span><br><span class="line">                    74:82:47:0a:af:3f:7d:a9:d8:de:49:39:9e:17:49:</span><br><span class="line">                    b4:f7:86:39:e1:02:25:6b:6e:94:82:95:3b:f2:62:</span><br><span class="line">                    07:6a:41:33:0b:3a:d2:31:a7:2b:68:c7:73:49:2f:</span><br><span class="line">                    7b:5c:83:51:05:5b:a4:5d:01:cf:3a:b9:98:f4:a1:</span><br><span class="line">                    6b:20:85:f9:3f:aa:e7:5e:e6:35:82:43:1e:d2:ed:</span><br><span class="line">                    90:8c:24:47:22:06:95:ab:8b:fd:12:0f:23:13:74:</span><br><span class="line">                    07:f4:02:e0:94:71:0e:7b:b8:ae:02:54:84:d6:e3:</span><br><span class="line">                    eb:91:a5:41:7b:6e:c5:26:57:9d:b6:ab:58:f0:e4:</span><br><span class="line">                    c4:d0:a1:9e:23:31:02:ff:60:98:a3:4e:2b:d2:58:</span><br><span class="line">                    6c:d1:12:a8:95:cb:19:69:0d:76:bc:50:e1:ed:6a:</span><br><span class="line">                    e3:a9:42:9a:b5:76:55:fb:34:41:b3:00:9a:99:cb:</span><br><span class="line">                    9c:d9</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                6D:26:4A:D1:30:4C:15:D6:EE:9B:63:95:AF:C1:63:7F:8B:83:31:68</span><br><span class="line">	//算法 参数 已加密的hash值：用CA的私钥对证书的所有域以及这些域的Hash值一起加密</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         08:2d:00:a8:6e:ad:67:87:6b:20:31:b0:d3:0f:52:64:cf:23:</span><br><span class="line">         ab:05:3a:53:8b:30:05:3e:47:0a:5c:19:1a:b0:e9:8d:4b:1d:</span><br><span class="line">         2c:f6:41:33:ba:b3:67:0a:77:46:bb:46:57:ef:f9:66:d8:68:</span><br><span class="line">         5d:41:be:3c:1d:35:f3:a3:58:4a:f4:f0:7f:87:1b:e4:0c:0c:</span><br><span class="line">         84:91:08:23:4c:9f:82:44:da:11:b1:60:b9:db:da:f6:36:58:</span><br><span class="line">         25:f6:ae:dc:4c:24:0d:1f:65:05:ee:9c:9c:c5:64:4a:a0:21:</span><br><span class="line">         4c:53:5a:3c:3e:c6:ad:67:cb:36:5e:6d:58:85:f5:2f:dd:6d:</span><br><span class="line">         c8:cc:7b:09:ba:8c:bd:6f:e8:53:d1:88:8d:35:90:48:ba:db:</span><br><span class="line">         5b:16:22:31:46:da:aa:91:ba:50:57:a5:38:08:af:05:ae:a1:</span><br><span class="line">         ec:3d:4f:fe:06:88:c8:60:9d:b9:16:00:7a:74:c8:a1:85:53:</span><br><span class="line">         dd:b5:0c:b7:09:f3:d4:e5:07:29:12:05:c2:83:84:c3:96:ec:</span><br><span class="line">         ba:ad:12:ad:1d:cf:52:d3:e3:ce:47:6a:89:4a:b1:39:c3:d2:</span><br><span class="line">         b7:e0:d5:77:d9:02:e5:17:89:09:00:b3:cb:38:38:ef:97:90:</span><br><span class="line">         35:27:41:90:cf:b7:98:34:21:69:bd:64:ad:2b:23:85:97:96:</span><br><span class="line">         6b:74:56:9b</span><br></pre></td></tr></table></figure>
<h1 id="1-3-4-为什么android要用这样的方式加密"><a href="#1-3-4-为什么android要用这样的方式加密" class="headerlink" title="1.3.4 为什么android要用这样的方式加密"></a>1.3.4 为什么android要用这样的方式加密</h1><ul>
<li><p>首先，如果你改变了apk包中的任何文件，那么在apk安装校验时，改变后的文件摘要信息与MANIFEST.MF的检验信息不同，于是验证失败，程序就不能成功安装。</p>
</li>
<li><p>其次，如果你对更改的过的文件相应的算出新的摘要值，然后更改MANIFEST.MF文件里面对应的属性值，那么必定与CERT.SF文件中算出的摘要值不一样，照样验证失败。</p>
</li>
<li><p>最后，如果你还不死心，继续计算MANIFEST.MF的摘要值，相应的更改CERT.SF里面的值，那么数字签名值必定与CERT.RSA文件中记录的不一样，还是失败。</p>
</li>
</ul>
<p>那么能不能继续伪造数字签名呢？不可能，因为没有数字证书对应的私钥。<br>所以，如果要重新打包后的应用程序能再Android设备上安装，必须对其进行重签名。</p>
<h1 id="1-3-5-总结"><a href="#1-3-5-总结" class="headerlink" title="1.3.5 总结"></a>1.3.5 总结</h1><h1 id="1-3-5-1-概念"><a href="#1-3-5-1-概念" class="headerlink" title="1.3.5.1 概念"></a>1.3.5.1 概念</h1><ul>
<li><p>数据指纹就是对一个数据源做SHA/MD5算法，这个值是唯一的</p>
</li>
<li><p>签名文件技术就是：数据指纹+RSA算法</p>
</li>
<li><p>证书文件中包含了公钥信息和其他信息</p>
</li>
<li><p>在Android签名之后，其中<strong>SF就是签名文件</strong>，<strong>RSA就是证书文件</strong>我们可以使用openssl来查看RSA文件中的证书信息和公钥信息</p>
</li>
</ul>
<h1 id="1-3-5-2-流程"><a href="#1-3-5-2-流程" class="headerlink" title="1.3.5.2 流程"></a>1.3.5.2 流程</h1><ul>
<li><p>对Apk中的每个文件做一次算法(数据摘要+Base64编码)，保存到MANIFEST.MF文件中</p>
</li>
<li><p>对MANIFEST.MF整个文件做一次算法(数据摘要+Base64编码)，存放到CERT.SF文件的头属性中，在对MANIFEST.MF文件中各个属性块做一次算法(数据摘要+Base64编码)，存到到一个属性块中。</p>
</li>
<li><p>对CERT.SF文件做签名，内容存档到CERT.RSA中</p>
</li>
</ul>
<blockquote>
<p>关于签名相关知识因为本人对安全这块涉及很少，所以基本都是引用自blog（<a href="https://blog.csdn.net/jiangwei0910410003/article/details/50402000）" target="_blank" rel="noopener">https://blog.csdn.net/jiangwei0910410003/article/details/50402000）</a> 的内容</p>
</blockquote>
<p>二.问题分析<br>前面我们对相关的知识做了梳理，现在回到我们的需求上来。已知需求为：要求系统级权限应用使用<strong>系统签名文件</strong>和指定的<strong>第三方签名文件</strong>都可以完成验证。在之前的PKMS服务的介绍中我们知道在<strong>应用安装</strong>和<strong>开机扫描的时候</strong>是需要做签名验证的，我们现在以应用安装为入口对源码进行跟踪。（关于PKMS服务的源码分析blog会在后续更新出来）</p>
<blockquote>
<p>下面的代码基于android6.0，设计的代码文件路径如下：<br>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java<br>frameworks/base/core/java/android/content/pm/PackageParser.java<br>libcore/luni/src/main/java/java/util/jar/StrictJarFile.java</p>
</blockquote>
<h1 id="2-1-installPackageLI"><a href="#2-1-installPackageLI" class="headerlink" title="2.1 installPackageLI"></a>2.1 installPackageLI</h1><p>这边要先声明 installPackageLI 并不是一个应用安装的入口方法，应用的安装涉及到的服务还有 PackageManagerInstallerService 服务，我们可以简单的把应用的安装分为两个步骤：一是拷贝阶段，二是安装阶段。而这个过程的控制则是由 PackageManagerInstallerService 进行控制的，我们这边要介绍的 installPackageLI 方法算是 第二阶段的入口方法（因为本文主要是介绍签名验证，关于应用安装过程会有跳过，毕竟这个不是本文的重点，后续文章会介绍6.0应用安装的过程。）</p>
<p>installPackageLI 方法比较长，篇幅原因就不全部拷贝出来了，这边列举下该方法做了哪些东西</p>
<ul>
<li>解析apk文件</li>
<li>收集应用的签名</li>
<li>检查安装参数是否带有强制替换参数，并做相应的处理</li>
<li>如果该应用已安装则做相应的验证,还需要判断升级的是否是系统应用</li>
<li>检查应用中定义的权限（这部分的判断会比较多,但不是这次分析的重点）</li>
<li>系统应用升级的话会对安装位置做检查不允许安装在sd卡上</li>
<li>执行 replacePackageLI 或者 installNewPackageLI</li>
</ul>
<p>这边我们的重点在第二点收集应用的签名和第四点中调用的 verifySignaturesLP 方法。首先我们先看看第二点的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">       <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           pkg = pp.parsePackage(tmpPackageFile, parseFlags);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">           res.setError(<span class="string">"Failed parse during installPackageLI"</span>, e);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Mark that we have an install time CPU ABI override.</span></span><br><span class="line">       pkg.cpuAbiOverride = args.abiOverride;</span><br><span class="line"></span><br><span class="line">       String pkgName = res.name = pkg.packageName;</span><br><span class="line">       <span class="keyword">if</span> ((pkg.applicationInfo.flags&amp;ApplicationInfo.FLAG_TEST_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_ALLOW_TEST) == <span class="number">0</span>) &#123;</span><br><span class="line">               res.setError(INSTALL_FAILED_TEST_ONLY, <span class="string">"installPackageLI"</span>);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//收集应用签名	</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           pp.collectCertificates(pkg, parseFlags);</span><br><span class="line">           pp.collectManifestDigest(pkg);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">           res.setError(<span class="string">"Failed collect during installPackageLI"</span>, e);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单,涉及到一个新的类 ackageParser.Package，我们跟踪进 collectCertificates 方法中查看</p>
<h1 id="2-2-collectCertificates"><a href="#2-2-collectCertificates" class="headerlink" title="2.2 collectCertificates"></a>2.2 collectCertificates</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">collectCertificates</span><span class="params">(Package pkg, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    pkg.mCertificates = <span class="keyword">null</span>;</span><br><span class="line">    pkg.mSignatures = <span class="keyword">null</span>;</span><br><span class="line">    pkg.mSigningKeys = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    collectCertificates(pkg, <span class="keyword">new</span> File(pkg.baseCodePath), flags);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ArrayUtils.isEmpty(pkg.splitCodePaths)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String splitCodePath : pkg.splitCodePaths) &#123;</span><br><span class="line">            collectCertificates(pkg, <span class="keyword">new</span> File(splitCodePath), flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这边我们重点关注重载方法 collectCertificates 这里面才是真正实现部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">collectCertificates</span><span class="params">(Package pkg, File apkFile, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    StrictJarFile jarFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        jarFile = <span class="keyword">new</span> StrictJarFile(apkPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Always verify manifest, regardless of source</span></span><br><span class="line">        <span class="keyword">final</span> ZipEntry manifestEntry = jarFile.findEntry(ANDROID_MANIFEST_FILENAME);</span><br><span class="line">        <span class="keyword">if</span> (manifestEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                    <span class="string">"Package "</span> + apkPath + <span class="string">" has no manifest"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;ZipEntry&gt; toVerify = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        toVerify.add(manifestEntry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we're parsing an untrusted package, verify all contents</span></span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PARSE_IS_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Iterator&lt;ZipEntry&gt; i = jarFile.iterator();</span><br><span class="line">            <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">final</span> ZipEntry entry = i.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (entry.isDirectory()) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> (entry.getName().startsWith(<span class="string">"META-INF/"</span>)) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> (entry.getName().equals(ANDROID_MANIFEST_FILENAME)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                toVerify.add(entry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Verify that entries are signed consistently with the first entry</span></span><br><span class="line">        <span class="comment">// we encountered. Note that for splits, certificates may have</span></span><br><span class="line">        <span class="comment">// already been populated during an earlier parse of a base APK.</span></span><br><span class="line">        <span class="keyword">for</span> (ZipEntry entry : toVerify) &#123;</span><br><span class="line">            <span class="keyword">final</span> Certificate[][] entryCerts = loadCertificates(jarFile, entry);</span><br><span class="line">            <span class="keyword">if</span> (ArrayUtils.isEmpty(entryCerts)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NO_CERTIFICATES,</span><br><span class="line">                        <span class="string">"Package "</span> + apkPath + <span class="string">" has no certificates at entry "</span></span><br><span class="line">                        + entry.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> Signature[] entrySignatures = convertToSignatures(entryCerts);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pkg.mCertificates == <span class="keyword">null</span>) &#123;</span><br><span class="line">                pkg.mCertificates = entryCerts;</span><br><span class="line">                pkg.mSignatures = entrySignatures;</span><br><span class="line">                pkg.mSigningKeys = <span class="keyword">new</span> ArraySet&lt;PublicKey&gt;();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; entryCerts.length; i++) &#123;</span><br><span class="line">                    pkg.mSigningKeys.add(entryCerts[i][<span class="number">0</span>].getPublicKey());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!Signature.areExactMatch(pkg.mSignatures, entrySignatures)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(</span><br><span class="line">                            INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES, <span class="string">"Package "</span> + apkPath</span><br><span class="line">                                    + <span class="string">" has mismatched certificates at entry "</span></span><br><span class="line">                                    + entry.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_CERTIFICATE_ENCODING,</span><br><span class="line">                <span class="string">"Failed to collect certificates from "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NO_CERTIFICATES,</span><br><span class="line">                <span class="string">"Failed to collect certificates from "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        closeQuietly(jarFile);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这边我们重点关注这里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pkg.mCertificates = entryCerts;</span><br><span class="line">pkg.mSignatures = entrySignatures;</span><br><span class="line">pkg.mSigningKeys = <span class="keyword">new</span> ArraySet&lt;PublicKey&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; entryCerts.length; i++) &#123;</span><br><span class="line">    pkg.mSigningKeys.add(entryCerts[i][<span class="number">0</span>].getPublicKey());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们的需求是增加一个支持系统级权限的签名，所以关于apk和签名校对来保证apk未被篡改不是我们关注的重点，我们关注的重点应该是证书文件（RSA文件）里面的公钥和我们需要比对的公钥是否是一致的。<br>所以前面签名校对我们直接跳过，直接看这边获取到的公钥信息保存在上面代码所示的位置。</p>
<blockquote>
<p>关于这个签名信息的获取过程建议查看姜老师的这篇blog：<a href="https://blog.csdn.net/jiangwei0910410003/article/details/50443505" target="_blank" rel="noopener">https://blog.csdn.net/jiangwei0910410003/article/details/50443505</a></p>
</blockquote>
<p>现在我们获取到了apk的公钥信息，那么在哪里进行比较呢？这时候我们回到 2.1 中 第四点提到的 verifySignaturesLP 方法<br>我们先来看看这个方法里面都做了什么</p>
<h1 id="2-4-verifySignaturesLP"><a href="#2-4-verifySignaturesLP" class="headerlink" title="2.4 verifySignaturesLP"></a>2.4 verifySignaturesLP</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifySignaturesLP</span><span class="params">(PackageSetting pkgSetting, PackageParser.Package pkg)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (pkgSetting.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// Already existing package. Make sure signatures match</span></span><br><span class="line">          <span class="keyword">boolean</span> match = compareSignatures(pkgSetting.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                  == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">          <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">              match = compareSignaturesCompat(pkgSetting.signatures, pkg)</span><br><span class="line">                      == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">              match = compareSignaturesRecover(pkgSetting.signatures, pkg)</span><br><span class="line">                      == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE, <span class="string">"Package "</span></span><br><span class="line">                      + pkg.packageName + <span class="string">" signatures do not match the "</span></span><br><span class="line">                      + <span class="string">"previously installed version; ignoring!"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这边是重点了 检查shared uid的签名信息</span></span><br><span class="line">      <span class="comment">// Check for shared user signatures</span></span><br><span class="line">      <span class="keyword">if</span> (pkgSetting.sharedUser != <span class="keyword">null</span> &amp;&amp; pkgSetting.sharedUser.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// Already existing package. Make sure signatures match</span></span><br><span class="line">          <span class="keyword">boolean</span> match = compareSignatures(pkgSetting.sharedUser.signatures.mSignatures,</span><br><span class="line">                  pkg.mSignatures) == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">          <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">              match = compareSignaturesCompat(pkgSetting.sharedUser.signatures, pkg)</span><br><span class="line">                      == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">              match = compareSignaturesRecover(pkgSetting.sharedUser.signatures, pkg)</span><br><span class="line">                      == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_SHARED_USER_INCOMPATIBLE,</span><br><span class="line">                      <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                      + <span class="string">" has no signatures that match those in shared user "</span></span><br><span class="line">                      + pkgSetting.sharedUser.name + <span class="string">"; ignoring!"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>如上面代码所示的，在这里会对 shared uid 的apk进行签名认证，那么我们现在思路有了，因为到这里的时候apk的公钥信息已经收集到了，那么只需要在这里多做一个判断：判断公钥信息是否和指定的第三方公钥信息一致就可以了。</p>
<blockquote>
<p>verifySignaturesLP 并不止是在 installPackageLI 被调用,在 scanPackageDirtyLI 都也有调用该方法，而 scanPackageDirtyLI 在安装apk和开机扫描apk（例如：installNewPackageLI replaceSystemPackageLI replaceNonSystemPackageLI）的时候都会被调用到，所以我们只需要在这个方法里面添加判断即可全部覆盖到。</p>
</blockquote>
<h1 id="三-解决方案"><a href="#三-解决方案" class="headerlink" title="三.解决方案"></a>三.解决方案</h1><h1 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">verifySignaturesLP</span><span class="params">(PackageSetting pkgSetting,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkgSetting.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Already existing package. Make sure signatures match</span></span><br><span class="line">        <span class="keyword">if</span> (compareSignatures(pkgSetting.signatures.mSignatures, pkg.mSignatures) !=</span><br><span class="line">            PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" signatures do not match the previously installed version; ignoring!"</span>);</span><br><span class="line">                mLastScanError = PackageManager.INSTALL_FAILED_UPDATE_INCOMPATIBLE;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check for shared user signatures</span></span><br><span class="line">    <span class="keyword">if</span> (pkgSetting.sharedUser != <span class="keyword">null</span> &amp;&amp; pkgSetting.sharedUser.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>( !isNeedSystemSign || (isNeedPackageSignatures() &amp;&amp; checkPackageSignatures(pkg))) &#123;</span><br><span class="line">            isNeedSystemSign = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (compareSignatures(pkgSetting.sharedUser.signatures.mSignatures,</span><br><span class="line">                pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" has no signatures that match those in shared user "</span></span><br><span class="line">                    + pkgSetting.sharedUser.name + <span class="string">"; ignoring!"</span>);</span><br><span class="line">            mLastScanError = PackageManager.INSTALL_FAILED_SHARED_USER_INCOMPATIBLE;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkPackageSignatures</span><span class="params">(PackageParser.Package pkg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"checkPackageSignatures("</span>+pkg.packageName+<span class="string">")"</span>);</span><br><span class="line">    <span class="keyword">if</span>(pkg == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    FileInputStream is =<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        is= <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"/etc/CERT.RSA"</span>));</span><br><span class="line">    &#125;<span class="keyword">catch</span>(java.io.FileNotFoundException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] readBuffer=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">8192</span>];;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (is.read(readBuffer, <span class="number">0</span>, readBuffer.length) != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// not using</span></span><br><span class="line">        &#125;</span><br><span class="line">        is.close();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(java.io.IOException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String publickeytxt = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    Signature auths=<span class="keyword">new</span> Signature(readBuffer);</span><br><span class="line">    <span class="comment">//Slog.i(TAG, "print:auths.toCharsString:"+auths.toCharsString());</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"auths.PublicKey:"</span>+auths.getPublicKey());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            StringBuffer sb=<span class="keyword">new</span> StringBuffer();</span><br><span class="line">            InputStreamReader read = <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"/etc/CERT.RSA"</span>)));</span><br><span class="line">            BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(read);</span><br><span class="line">            <span class="keyword">while</span>((publickeytxt = bufferedReader.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                sb.append(publickeytxt);</span><br><span class="line">            &#125;</span><br><span class="line">            publickeytxt = sb.toString();</span><br><span class="line">            Slog.i(TAG, <span class="string">"PublicKey: "</span> + publickeytxt);</span><br><span class="line">            read.close();</span><br><span class="line">            bufferedReader.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(java.io.IOException e1)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Signature authsSignatures[] = <span class="keyword">new</span> Signature[<span class="number">1</span>];</span><br><span class="line">    authsSignatures[<span class="number">0</span>]=auths;</span><br><span class="line">    <span class="keyword">if</span>(pkg.mSignatures[<span class="number">0</span>]==<span class="keyword">null</span>)&#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"package have not Signatures"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"pkg.mSignatures[0]:"</span>+ pkg.mSignatures[<span class="number">0</span>].getPublicKey());</span><br><span class="line">            Slog.i(TAG, <span class="string">"publickeytxt.length(): "</span> + publickeytxt.length() + <span class="string">"  index :"</span></span><br><span class="line">                    + (pkg.mSignatures[<span class="number">0</span>].getPublicKey() + <span class="string">""</span>).indexOf(publickeytxt));</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//if(PackageManager.SIGNATURE_MATCH == compareSignatures(authsSignatures,pkg.mSignatures))&#123;</span></span><br><span class="line">    <span class="comment">//	return true;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(authsSignatures[<span class="number">0</span>].getPublicKey().equals(pkg.mSignatures[<span class="number">0</span>].getPublicKey()))&#123;</span><br><span class="line">            isNeedSystemSign = <span class="keyword">false</span>;</span><br><span class="line">            Slog.i(TAG, <span class="string">"verification success1"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(java.security.cert.CertificateException e)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>((publickeytxt.length() &gt; <span class="number">0</span>) &amp;&amp; (pkg.mSignatures[<span class="number">0</span>].getPublicKey() + <span class="string">""</span>).indexOf(publickeytxt) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                isNeedSystemSign = <span class="keyword">false</span>;</span><br><span class="line">                Slog.i(TAG, <span class="string">"verification success2"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e1)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Slog.i(TAG, <span class="string">"verification  failed"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encryptionMD5</span><span class="params">(<span class="keyword">byte</span>[] byteStr)</span> </span>&#123;</span><br><span class="line">    MessageDigest messageDigest = <span class="keyword">null</span>;</span><br><span class="line">    StringBuffer md5StrBuff = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        messageDigest = MessageDigest.getInstance(<span class="string">"MD5"</span>);</span><br><span class="line">        messageDigest.reset();</span><br><span class="line">        messageDigest.update(byteStr);</span><br><span class="line">        <span class="keyword">byte</span>[] byteArray = messageDigest.digest();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; byteArray.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Integer.toHexString(<span class="number">0xFF</span> &amp; byteArray[i]).length() == <span class="number">1</span>) &#123;</span><br><span class="line">                md5StrBuff.append(<span class="string">"0"</span>).append(Integer.toHexString(<span class="number">0xFF</span> &amp; byteArray[i]));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                md5StrBuff.append(Integer.toHexString(<span class="number">0xFF</span> &amp; byteArray[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> md5StrBuff.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMD5</span><span class="params">(Context mContext, String packName)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PackageInfo packageInfo = mContext.getPackageManager().getPackageInfo(packName,</span><br><span class="line">                PackageManager.GET_SIGNATURES);</span><br><span class="line">        Signature[] signs = packageInfo.signatures;</span><br><span class="line"></span><br><span class="line">        Signature sign = signs[<span class="number">0</span>];</span><br><span class="line">        String signStr = encryptionMD5(sign.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> signStr;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方案2不需要使用到@hide方法就可以实现。</p>
<h1 id="四-补充"><a href="#四-补充" class="headerlink" title="四.补充"></a>四.补充</h1><p>方案中获取RSA文件公钥的方法在app中是无法直接使用的，因为有些方法是hide的只能在framework层或者反射使用，这样不是很方便，这边根据源码提取一个简单的类可以在app中直接使用。有兴趣的同学也可以用jks文件打包一个apk进行验证：用同一个jks文件打包两个apk然后分别解压获取RAS文件 用下面的方法获取公钥验证是否一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.Certificate;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SignatureTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] mSignature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mHashCode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mHaveHashCode;</span><br><span class="line">    <span class="keyword">private</span> SoftReference&lt;String&gt; mStringRef;</span><br><span class="line">    <span class="keyword">private</span> Certificate[] mCertificateChain;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create Signature from an existing raw byte array.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SignatureTest</span><span class="params">(<span class="keyword">byte</span>[] signature)</span> </span>&#123;</span><br><span class="line">        mSignature = signature.clone();</span><br><span class="line">        mCertificateChain = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create signature from a certificate chain. Used for backward</span></span><br><span class="line"><span class="comment">     * compatibility.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> CertificateEncodingException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SignatureTest</span><span class="params">(Certificate[] certificateChain)</span> <span class="keyword">throws</span> CertificateEncodingException </span>&#123;</span><br><span class="line">        mSignature = certificateChain[<span class="number">0</span>].getEncoded();</span><br><span class="line">        <span class="keyword">if</span> (certificateChain.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            mCertificateChain = Arrays.copyOfRange(certificateChain, <span class="number">1</span>, certificateChain.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">parseHexDigit</span><span class="params">(<span class="keyword">int</span> nibble)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">'0'</span> &lt;= nibble &amp;&amp; nibble &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> nibble - <span class="string">'0'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'a'</span> &lt;= nibble &amp;&amp; nibble &lt;= <span class="string">'f'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> nibble - <span class="string">'a'</span> + <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'A'</span> &lt;= nibble &amp;&amp; nibble &lt;= <span class="string">'F'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> nibble - <span class="string">'A'</span> + <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid character "</span> + nibble + <span class="string">" in hex string"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create Signature from a text representation previously returned by</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #toChars&#125; or &#123;<span class="doctag">@link</span> #toCharsString()&#125;. Signatures are expected to</span></span><br><span class="line"><span class="comment">     * be a hex-encoded ASCII string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text hex-encoded string representing the signature</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException when signature is odd-length</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SignatureTest</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] input = text.getBytes();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = input.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (N % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"text size "</span> + N + <span class="string">" is not even"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] sig = <span class="keyword">new</span> <span class="keyword">byte</span>[N / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> sigIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> hi = parseHexDigit(input[i++]);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> lo = parseHexDigit(input[i++]);</span><br><span class="line">            sig[sigIndex++] = (<span class="keyword">byte</span>) ((hi &lt;&lt; <span class="number">4</span>) | lo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mSignature = sig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Encode the Signature as ASCII text.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">char</span>[] toChars() &#123;</span><br><span class="line">        <span class="keyword">return</span> toChars(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Encode the Signature as ASCII text in to an existing array.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> existingArray Existing char array or null.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outLen Output parameter for the number of characters written in</span></span><br><span class="line"><span class="comment">     * to the array.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Returns either &lt;var&gt;existingArray&lt;/var&gt; if it was large enough</span></span><br><span class="line"><span class="comment">     * to hold the ASCII representation, or a newly created char[] array if</span></span><br><span class="line"><span class="comment">     * needed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">char</span>[] toChars(<span class="keyword">char</span>[] existingArray, <span class="keyword">int</span>[] outLen) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] sig = mSignature;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = sig.length;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N2 = N*<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">char</span>[] text = existingArray == <span class="keyword">null</span> || N2 &gt; existingArray.length</span><br><span class="line">                ? <span class="keyword">new</span> <span class="keyword">char</span>[N2] : existingArray;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;N; j++) &#123;</span><br><span class="line">            <span class="keyword">byte</span> v = sig[j];</span><br><span class="line">            <span class="keyword">int</span> d = (v&gt;&gt;<span class="number">4</span>)&amp;<span class="number">0xf</span>;</span><br><span class="line">            text[j*<span class="number">2</span>] = (<span class="keyword">char</span>)(d &gt;= <span class="number">10</span> ? (<span class="string">'a'</span> + d - <span class="number">10</span>) : (<span class="string">'0'</span> + d));</span><br><span class="line">            d = v&amp;<span class="number">0xf</span>;</span><br><span class="line">            text[j*<span class="number">2</span>+<span class="number">1</span>] = (<span class="keyword">char</span>)(d &gt;= <span class="number">10</span> ? (<span class="string">'a'</span> + d - <span class="number">10</span>) : (<span class="string">'0'</span> + d));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (outLen != <span class="keyword">null</span>) outLen[<span class="number">0</span>] = N;</span><br><span class="line">        <span class="keyword">return</span> text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the result of &#123;<span class="doctag">@link</span> #toChars()&#125; as a String.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toCharsString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String str = mStringRef == <span class="keyword">null</span> ? <span class="keyword">null</span> : mStringRef.get();</span><br><span class="line">        <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> str;</span><br><span class="line">        &#125;</span><br><span class="line">        str = <span class="keyword">new</span> String(toChars());</span><br><span class="line">        mStringRef = <span class="keyword">new</span> SoftReference&lt;String&gt;(str);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the contents of this signature as a byte array.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] toByteArray() &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[mSignature.length];</span><br><span class="line">        System.arraycopy(mSignature, <span class="number">0</span>, bytes, <span class="number">0</span>, mSignature.length);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the public key for this signature.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> CertificateException when Signature isn't a valid X.509</span></span><br><span class="line"><span class="comment">     *             certificate; shouldn't happen.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PublicKey <span class="title">getPublicKey</span><span class="params">()</span> <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> CertificateFactory certFactory = CertificateFactory.getInstance(<span class="string">"X.509"</span>);</span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(mSignature);</span><br><span class="line">        <span class="keyword">final</span> Certificate cert = certFactory.generateCertificate(bais);</span><br><span class="line">        <span class="keyword">return</span> cert.getPublicKey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mHaveHashCode) &#123;</span><br><span class="line">            <span class="keyword">return</span> mHashCode;</span><br><span class="line">        &#125;</span><br><span class="line">        mHashCode = Arrays.hashCode(mSignature);</span><br><span class="line">        mHaveHashCode = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> mHashCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PublicKey <span class="title">getPublickey</span><span class="params">(String path)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        FileInputStream is =<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            is= <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(path));</span><br><span class="line">        &#125;<span class="keyword">catch</span>(java.io.FileNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] readBuffer=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">8192</span>];;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (is.read(readBuffer, <span class="number">0</span>, readBuffer.length) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// not using</span></span><br><span class="line">            &#125;</span><br><span class="line">            is.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(java.io.IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String publickeytxt = <span class="keyword">null</span>;</span><br><span class="line">        SignatureTest auths=<span class="keyword">new</span> SignatureTest(readBuffer);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> auths.getPublicKey();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/07/Binder应用层核心类/" rel="next" title="Binder应用层核心类">
                <i class="fa fa-chevron-left"></i> Binder应用层核心类
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/12/activity启动过程/" rel="prev" title="activity启动过程">
                activity启动过程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="道墟" />
            
              <p class="site-author-name" itemprop="name">道墟</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">Kategorien</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">Tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-背景知识"><span class="nav-text">一.背景知识</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-1-android权限分级"><span class="nav-text">1.1 android权限分级</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-2-系统签名类型"><span class="nav-text">1.2 系统签名类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-签名相关知识"><span class="nav-text">1.3 签名相关知识</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-1-数据摘要"><span class="nav-text">1.3.1 数据摘要</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-2-jarsign和signapk工具"><span class="nav-text">1.3.2 jarsign和signapk工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-3-签名后生成的文件"><span class="nav-text">1.3.3 签名后生成的文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-3-1-MANIFEST-MF文件"><span class="nav-text">1.3.3.1 MANIFEST.MF文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-3-2-SF文件"><span class="nav-text">1.3.3.2 SF文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-3-3-RSA文件"><span class="nav-text">1.3.3.3 RSA文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-4-为什么android要用这样的方式加密"><span class="nav-text">1.3.4 为什么android要用这样的方式加密</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-5-总结"><span class="nav-text">1.3.5 总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-5-1-概念"><span class="nav-text">1.3.5.1 概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-3-5-2-流程"><span class="nav-text">1.3.5.2 流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-installPackageLI"><span class="nav-text">2.1 installPackageLI</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-2-collectCertificates"><span class="nav-text">2.2 collectCertificates</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-4-verifySignaturesLP"><span class="nav-text">2.4 verifySignaturesLP</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三-解决方案"><span class="nav-text">三.解决方案</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#方案一"><span class="nav-text">方案一</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#方案二"><span class="nav-text">方案二</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四-补充"><span class="nav-text">四.补充</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">道墟</span>

  

  
</div>




  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
